name: M37 Copilot CI/CD Pipeline

on:
  push:
    branches:
      - feat/m37-copilot-v3.7
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level to run'
        required: true
        default: 'full'
        type: choice
        options:
          - smoke
          - unit
          - integration
          - full
          - performance

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  TESTING: true
  LOG_LEVEL: INFO

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-quality:
    name: Code Quality & Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install flake8 black isort mypy bandit safety
          pip install -r backend/requirements.txt

      - name: Run Black formatter check
        run: |
          black --check --diff backend/src backend/tests

      - name: Run isort import sorting check
        run: |
          isort --check-only --diff backend/src backend/tests

      - name: Run flake8 linting
        run: |
          flake8 backend/src backend/tests --max-line-length=100 --extend-ignore=E203,W503

      - name: Run mypy type checking
        run: |
          mypy backend/src --ignore-missing-imports

      - name: Run bandit security scan
        run: |
          bandit -r backend/src -f json -o bandit-report.json

      - name: Run safety vulnerability scan
        run: |
          safety check --json --output safety-report.json || true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Node.js dependencies
        run: |
          cd apps/web
          npm ci

      - name: Run ESLint
        run: |
          cd apps/web
          npm run lint

      - name: Run TypeScript type check
        run: |
          cd apps/web
          npm run type-check

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ìŠ¤í‚¤ë§ˆ ë° ì •ì±… ê²€ì¦
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  schema-validation:
    name: Schema & Policy Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install jsonschema pyyaml

      - name: Validate JSON schemas
        run: |
          python -c "
          import json
          import jsonschema
          import os

          schema_dir = 'ops/schemas'
          for schema_file in os.listdir(schema_dir):
              if schema_file.endswith('.json'):
                  with open(os.path.join(schema_dir, schema_file)) as f:
                      schema = json.load(f)
                  jsonschema.Draft7Validator.check_schema(schema)
                  print(f'âœ“ {schema_file} is valid')
          "

      - name: Validate YAML policies
        run: |
          python -c "
          import yaml
          import os

          with open('ops/policies/copilot_policies.yml') as f:
              policies = yaml.safe_load(f)

          # ì •ì±… êµ¬ì¡° ê²€ì¦
          assert 'tools' in policies
          assert 'roles' in policies
          assert 'risk_matrix' in policies
          print('âœ“ Copilot policies are valid')
          "

      - name: Validate WhyTrace patterns
        run: |
          python -c "
          import yaml
          import os

          patterns_file = 'backend/src/m37/whytrace/patterns/default_patterns.yml'
          if os.path.exists(patterns_file):
              with open(patterns_file) as f:
                  patterns = yaml.safe_load(f)
              print('âœ“ WhyTrace patterns are valid')
          else:
              print('âš  WhyTrace patterns file not found, skipping')
          "

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: [code-quality, schema-validation]

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: kis_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test -d kis_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        test-type: [unit, integration, api, e2e]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov pytest-asyncio pytest-xdist pytest-timeout

      - name: Set environment variables
        run: |
          echo "DATABASE_URL=postgresql://test:test@localhost:5432/kis_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/15" >> $GITHUB_ENV
          echo "JWT_SECRET_KEY=test-secret-key-for-ci" >> $GITHUB_ENV
          echo "ENVIRONMENT=testing" >> $GITHUB_ENV

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        run: |
          cd backend
          pytest tests/ -m "unit" --cov=src --cov-report=xml --cov-report=term-missing -v

      - name: Run integration tests
        if: matrix.test-type == 'integration'
        run: |
          cd backend
          pytest tests/ -m "integration" --cov=src --cov-report=xml --cov-report=term-missing -v

      - name: Run API tests
        if: matrix.test-type == 'api'
        run: |
          cd backend
          pytest tests/test_m37_api.py -v --timeout=30

      - name: Run E2E tests
        if: matrix.test-type == 'e2e'
        run: |
          cd backend
          pytest tests/test_m37_e2e.py -v --timeout=60

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage.xml
          flags: backend,${{ matrix.test-type }}
          name: backend-${{ matrix.test-type }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-backend-${{ matrix.test-type }}
          path: |
            backend/htmlcov/
            backend/coverage.xml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: [code-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('apps/web/package-lock.json') }}

      - name: Install dependencies
        run: |
          cd apps/web
          npm ci

      - name: Run unit tests
        run: |
          cd apps/web
          npm run test:unit

      - name: Run component tests
        run: |
          cd apps/web
          npm run test:components

      - name: Build frontend
        run: |
          cd apps/web
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: apps/web/dist/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [backend-tests]
    if: github.event.inputs.test_level == 'performance' || github.event.inputs.test_level == 'full'

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest-benchmark locust

      - name: Run performance tests
        run: |
          cd backend
          pytest tests/ -m "performance" -v --benchmark-only --benchmark-json=benchmark.json

      - name: Run load tests
        run: |
          cd backend
          # Start FastAPI server in background
          uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          sleep 10

          # Run Locust load test
          locust -f tests/load_test.py --headless -u 50 -r 10 -t 60s --host http://localhost:8000

      - name: Upload performance results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: |
            backend/benchmark.json
            backend/locust_report.html

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: [backend-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run security tests
        run: |
          cd backend
          pytest tests/ -m "security" -v

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'M37-Copilot'
          path: '.'
          format: 'ALL'

      - name: Upload OWASP report
        uses: actions/upload-artifact@v3
        with:
          name: owasp-report
          path: reports/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker-build:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build backend Docker image
        run: |
          cd backend
          docker build -t m37-copilot-backend:test .

      - name: Build frontend Docker image
        run: |
          cd apps/web
          docker build -t m37-copilot-frontend:test .

      - name: Test Docker containers
        run: |
          # Backend container test
          docker run --rm -d --name backend-test -p 8000:8000 m37-copilot-backend:test
          sleep 10
          curl -f http://localhost:8000/health || exit 1
          docker stop backend-test

      - name: Vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'm37-copilot-backend:test'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # í†µí•© í…ŒìŠ¤íŠ¸ (ì „ì²´ ì‹œìŠ¤í…œ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  integration-full:
    name: Full System Integration Test
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event.inputs.test_level == 'full' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start full system with Docker Compose
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 30

      - name: Run integration tests
        run: |
          # Health check all services
          curl -f http://localhost:8000/health
          curl -f http://localhost:3000

          # Run E2E tests against running system
          cd backend
          pytest tests/test_m37_e2e.py -v --timeout=120

      - name: Collect logs
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml logs > system-logs.txt

      - name: Stop system
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down

      - name: Upload system logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: system-logs
          path: system-logs.txt

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ë°°í¬ ì¤€ë¹„ ë° ê²€ì¦
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deployment-check:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [integration-full, security-tests, performance-tests]
    if: github.ref == 'refs/heads/feat/m37-copilot-v3.7'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deployment configurations
        run: |
          # Kubernetes manifests validation
          if [ -d "k8s" ]; then
            kubectl --dry-run=client --validate=true apply -f k8s/
          fi

          # Docker Compose validation
          docker-compose -f docker-compose.prod.yml config

      - name: Check version consistency
        run: |
          # Version in spec should match branch
          grep -q "v3.7.0" spec/copilot.spec.md
          grep -q "M37" spec/copilot.spec.md

      - name: Generate deployment report
        run: |
          echo "# M37 Copilot v3.7.0 Deployment Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "## Test Results Summary" >> deployment-report.md
          echo "- âœ… Code Quality: Passed" >> deployment-report.md
          echo "- âœ… Backend Tests: Passed" >> deployment-report.md
          echo "- âœ… Frontend Tests: Passed" >> deployment-report.md
          echo "- âœ… Security Tests: Passed" >> deployment-report.md
          echo "- âœ… Performance Tests: Passed" >> deployment-report.md
          echo "- âœ… Integration Tests: Passed" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## Features Implemented" >> deployment-report.md
          echo "- ðŸ¤– RAG ê²€ìƒ‰ ì‹œìŠ¤í…œ (TF-IDF + BM25)" >> deployment-report.md
          echo "- ðŸ” WhyTrace QA ì—”ì§„" >> deployment-report.md
          echo "- âš™ï¸ ì—ì´ì „íŠ¸ ì‹¤í–‰ ì—”ì§„" >> deployment-report.md
          echo "- âœ… ìŠ¹ì¸ ì›Œí¬í”Œë¡œìš°" >> deployment-report.md
          echo "- ðŸŒ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° API" >> deployment-report.md
          echo "- ðŸ’¾ ë¶„ì‚° ìºì‹± ì‹œìŠ¤í…œ" >> deployment-report.md
          echo "- ðŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§" >> deployment-report.md
          echo "- ðŸ” ì—”í„°í”„ë¼ì´ì¦ˆ ë³´ì•ˆ" >> deployment-report.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report
          path: deployment-report.md

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ì•Œë¦¼ ë° ì™„ë£Œ
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [deployment-check]
    if: always()

    steps:
      - name: Determine overall status
        run: |
          if [ "${{ needs.deployment-check.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_ENV
            echo "message=ðŸŽ‰ M37 Copilot v3.7.0 ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! ë°°í¬ ì¤€ë¹„ ì™„ë£Œ" >> $GITHUB_ENV
          else
            echo "status=failure" >> $GITHUB_ENV
            echo "message=âŒ M37 Copilot v3.7.0 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_ENV
          fi

      - name: Create summary
        run: |
          echo "## ðŸš€ M37 Copilot v3.7.0 CI/CD ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ìƒíƒœ**: ${{ env.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**ë©”ì‹œì§€**: ${{ env.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Tests: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Tests: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ${{ needs.security-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-full.result }}" >> $GITHUB_STEP_SUMMARY