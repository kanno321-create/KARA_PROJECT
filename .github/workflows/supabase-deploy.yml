name: Deploy to Supabase

on:
  push:
    branches: [ "main" ]
    paths:
      - "supabase/**"
      - ".github/workflows/supabase-deploy.yml"
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      # Gate: secrets는 if:에 쓰지 않고, 셸에서 검사 → 출력값으로 제어
      - name: Gate / check secrets
        id: gate
        shell: bash
        env:
          PRJ: ${{ secrets.SUPABASE_PROJECT_REF }}
          TOK: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          DBP: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -euo pipefail
          ok=0
          if [ -n "${PRJ:-}" ] && [ -n "${TOK:-}" ]; then
            ok=1
            echo "Gate: secrets present"
          else
            echo "Gate: secrets missing (SUPABASE_PROJECT_REF or SUPABASE_ACCESS_TOKEN). Skipping deploy steps."
          fi
          echo "ok=${ok}" >> "$GITHUB_OUTPUT"

      - name: Link Supabase project
        if: steps.gate.outputs.ok == '1'
        shell: bash
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          if [ -n "${{ secrets.SUPABASE_DB_PASSWORD }}" ]; then
            supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}" --password "${{ secrets.SUPABASE_DB_PASSWORD }}"
          else
            supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}"
          fi
          supabase status -o pretty

      # 필요 시 주석 해제
      # - name: Push DB changes
      #   if: steps.gate.outputs.ok == '1'
      #   run: supabase db push --include-all --debug