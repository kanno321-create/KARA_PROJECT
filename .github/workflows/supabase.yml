name: Supabase Deploy (Simple)

on:
  push:
    branches: [ "main" ]
    paths:
      - "supabase/**"
      - ".github/workflows/supabase.yml"
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      # Gate: secretsÎ•º if:Ïóê Ïì∞ÏßÄ ÎßêÍ≥†, ÏÖ∏ÏóêÏÑú Í≤ÄÏÇ¨Ìï¥ Ï∂úÎ†•Í∞íÏúºÎ°ú Ï†úÏñ¥
      - name: Gate / check secrets
        id: gate
        shell: bash
        env:
          PRJ: ${{ secrets.SUPABASE_PROJECT_REF }}
          TOK: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          DBP: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -euo pipefail
          ok=0
          if [ -n "${PRJ:-}" ] && [ -n "${TOK:-}" ]; then
            ok=1
            echo "Gate: secrets present"
          else
            echo "Gate: secrets missing (SUPABASE_PROJECT_REF or SUPABASE_ACCESS_TOKEN). Skipping deploy steps."
          fi
          echo "ok=${ok}" >> "$GITHUB_OUTPUT"

      - name: Link Supabase
        if: steps.gate.outputs.ok == '1'
        shell: bash
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          if [ -n "${{ secrets.SUPABASE_DB_PASSWORD }}" ]; then
            supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}" --password "${{ secrets.SUPABASE_DB_PASSWORD }}"
          else
            supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}"
          fi
          supabase status -o pretty

      - name: Deploy Database Changes
        if: steps.gate.outputs.ok == '1'
        shell: bash
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          echo "üóÑÔ∏è Pushing database changes..."
          if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations)" ]; then
            supabase db push
            echo "‚úÖ Database deployment completed"
          else
            echo "‚ÑπÔ∏è No database changes to deploy"
          fi