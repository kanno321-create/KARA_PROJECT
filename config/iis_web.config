<?xml version="1.0" encoding="UTF-8"?>
<!-- config/iis_web.config -->
<!-- KIS Estimator GA 1.0 - IIS URL Rewrite 설정 -->
<configuration>
    <system.webServer>
        <!-- URL Rewrite Rules -->
        <rewrite>
            <rules>
                <!-- HTTP to HTTPS 리다이렉션 -->
                <rule name="Redirect to HTTPS" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTPS}" pattern="off" ignoreCase="true" />
                    </conditions>
                    <action type="Redirect" url="https://{HTTP_HOST}/{R:0}" redirectType="Permanent" />
                </rule>

                <!-- API v1 라우팅 -->
                <rule name="KIS Estimator API" stopProcessing="true">
                    <match url="^v1/(.*)" />
                    <action type="Rewrite" url="http://127.0.0.1:8787/v1/{R:1}" />
                    <serverVariables>
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_FORWARDED_HOST" value="{HTTP_HOST}" />
                        <set name="HTTP_X_ORIGINAL_URL" value="{URL}" />
                    </serverVariables>
                </rule>
            </rules>

            <!-- Outbound Rules -->
            <outboundRules>
                <!-- CORS Headers -->
                <rule name="Add CORS Headers">
                    <match serverVariable="RESPONSE_Access-Control-Allow-Origin" pattern=".*" />
                    <action type="Rewrite" value="*" />
                </rule>
            </outboundRules>
        </rewrite>

        <!-- Security Headers -->
        <httpProtocol>
            <customHeaders>
                <add name="X-Frame-Options" value="SAMEORIGIN" />
                <add name="X-Content-Type-Options" value="nosniff" />
                <add name="X-XSS-Protection" value="1; mode=block" />
                <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" />
            </customHeaders>
        </httpProtocol>

        <!-- Request Filtering -->
        <security>
            <requestFiltering>
                <!-- Maximum content length (10MB) -->
                <requestLimits maxAllowedContentLength="10485760" />

                <!-- Block dangerous file extensions -->
                <fileExtensions>
                    <add fileExtension=".exe" allowed="false" />
                    <add fileExtension=".dll" allowed="false" />
                    <add fileExtension=".cmd" allowed="false" />
                    <add fileExtension=".bat" allowed="false" />
                </fileExtensions>

                <!-- HTTP Verbs -->
                <verbs>
                    <add verb="GET" allowed="true" />
                    <add verb="POST" allowed="true" />
                    <add verb="PUT" allowed="false" />
                    <add verb="DELETE" allowed="false" />
                    <add verb="OPTIONS" allowed="true" />
                </verbs>
            </requestFiltering>

            <!-- Dynamic IP Restrictions -->
            <dynamicIpSecurity>
                <denyByConcurrentRequests enabled="true" maxConcurrentRequests="100" />
                <denyByRequestRate enabled="true" maxRequests="100" requestIntervalInMilliseconds="1000" />
            </dynamicIpSecurity>
        </security>

        <!-- Compression -->
        <urlCompression doStaticCompression="true" doDynamicCompression="true" />

        <!-- Caching -->
        <caching>
            <profiles>
                <add extension=".json" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
            </profiles>
        </caching>

        <!-- Logging -->
        <httpLogging selectiveLogging="LogAll">
            <fields>
                <clear />
                <add logFieldName="Date" sourceName="Date" sourceType="ServerVariable" />
                <add logFieldName="Time" sourceName="Time" sourceType="ServerVariable" />
                <add logFieldName="ClientIP" sourceName="c-ip" sourceType="ServerVariable" />
                <add logFieldName="Method" sourceName="Method" sourceType="ServerVariable" />
                <add logFieldName="UriStem" sourceName="cs-uri-stem" sourceType="ServerVariable" />
                <add logFieldName="UriQuery" sourceName="cs-uri-query" sourceType="ServerVariable" />
                <add logFieldName="HttpStatus" sourceName="sc-status" sourceType="ServerVariable" />
                <add logFieldName="Win32Status" sourceName="sc-win32-status" sourceType="ServerVariable" />
                <add logFieldName="TimeTaken" sourceName="TimeTaken" sourceType="ServerVariable" />
                <add logFieldName="UserAgent" sourceName="cs(User-Agent)" sourceType="ServerVariable" />
            </fields>
        </httpLogging>

        <!-- Error Pages -->
        <httpErrors errorMode="Custom" existingResponse="Replace">
            <clear />
            <error statusCode="404" subStatusCode="-1" path="/errors/404.html" responseMode="ExecuteURL" />
            <error statusCode="500" subStatusCode="-1" path="/errors/500.html" responseMode="ExecuteURL" />
            <error statusCode="502" subStatusCode="-1" path="/errors/502.html" responseMode="ExecuteURL" />
            <error statusCode="503" subStatusCode="-1" path="/errors/503.html" responseMode="ExecuteURL" />
        </httpErrors>

        <!-- Application Request Routing Cache -->
        <applicationRequestRouting>
            <cache enabled="false" />
        </applicationRequestRouting>
    </system.webServer>

    <!-- Application Settings -->
    <appSettings>
        <add key="BackendUrl" value="http://127.0.0.1:8787" />
        <add key="Environment" value="PRODUCTION" />
        <add key="RbacEvidence" value="ADMIN_ONLY" />
        <add key="MixedExceptionsMonthly" value="2" />
    </appSettings>
</configuration>