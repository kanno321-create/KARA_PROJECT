{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://kis-core.com/schemas/drawing_packet.json",
  "title": "Drawing Packet Schema",
  "description": "CAD/PDF drawing analysis schema with BOM, dimensions, and revision tracking",
  "type": "object",
  "properties": {
    "drawing_id": {
      "type": "string",
      "pattern": "^DWG-[0-9]{8}-[A-Z0-9]{6}$",
      "description": "Unique drawing identifier"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "created": {
          "type": "string",
          "format": "date-time"
        },
        "updated": {
          "type": "string",
          "format": "date-time"
        },
        "project_code": {
          "type": "string",
          "pattern": "^[A-Z0-9]{3,10}$"
        },
        "drawing_title": {
          "type": "string",
          "minLength": 1
        },
        "scale": {
          "type": "string",
          "pattern": "^1:[0-9]+$"
        },
        "units": {
          "type": "string",
          "enum": ["mm", "cm", "m", "inch", "ft"]
        },
        "discipline": {
          "type": "string",
          "enum": ["mechanical", "electrical", "structural", "piping", "instrumentation", "civil"]
        },
        "drawing_type": {
          "type": "string",
          "enum": ["assembly", "detail", "section", "elevation", "plan", "schematic", "isometric"]
        }
      },
      "required": ["created", "project_code", "drawing_title", "scale", "units", "discipline"]
    },
    "files": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "file_path": {
            "type": "string",
            "description": "Relative path to evidence folder"
          },
          "file_type": {
            "type": "string",
            "enum": ["dwg", "pdf", "step", "iges", "dxf", "png", "svg"]
          },
          "file_size": {
            "type": "integer",
            "minimum": 0
          },
          "hash": {
            "type": "string",
            "pattern": "^[a-f0-9]{64}$",
            "description": "SHA256 hash for integrity verification"
          },
          "extraction_timestamp": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": ["file_path", "file_type", "file_size", "hash"]
      },
      "minItems": 1
    },
    "bom": {
      "type": "array",
      "description": "Bill of Materials extracted from drawing",
      "items": {
        "type": "object",
        "properties": {
          "item_number": {
            "type": "string",
            "minLength": 1
          },
          "part_number": {
            "type": "string",
            "minLength": 1
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "material": {
            "type": "string"
          },
          "standard": {
            "type": "string",
            "description": "KS, ASTM, ISO, JIS, etc."
          },
          "quantity": {
            "type": "number",
            "minimum": 0
          },
          "unit": {
            "type": "string",
            "enum": ["ea", "m", "m2", "m3", "kg", "set", "lot"]
          },
          "weight_kg": {
            "type": "number",
            "minimum": 0
          },
          "supplier": {
            "type": "string"
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "AI extraction confidence score"
          },
          "evidence_region": {
            "type": "object",
            "description": "Bounding box coordinates where item was found",
            "properties": {
              "x": {"type": "number"},
              "y": {"type": "number"},
              "width": {"type": "number"},
              "height": {"type": "number"}
            }
          }
        },
        "required": ["item_number", "part_number", "description", "quantity", "unit"]
      }
    },
    "dimensions": {
      "type": "array",
      "description": "Critical dimensions extracted from drawing",
      "items": {
        "type": "object",
        "properties": {
          "dimension_id": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": ["linear", "angular", "radial", "diameter", "arc_length"]
          },
          "value": {
            "type": "number"
          },
          "unit": {
            "type": "string",
            "enum": ["mm", "cm", "m", "inch", "ft", "degree", "radian"]
          },
          "tolerance_plus": {
            "type": "number",
            "minimum": 0
          },
          "tolerance_minus": {
            "type": "number",
            "minimum": 0
          },
          "feature_type": {
            "type": "string",
            "enum": ["hole", "slot", "length", "width", "height", "radius", "angle", "gap"]
          },
          "criticality": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"]
          },
          "evidence_region": {
            "type": "object",
            "description": "Bounding box coordinates where dimension was found",
            "properties": {
              "x": {"type": "number"},
              "y": {"type": "number"},
              "width": {"type": "number"},
              "height": {"type": "number"}
            }
          }
        },
        "required": ["dimension_id", "type", "value", "unit", "feature_type"]
      }
    },
    "revisions": {
      "type": "array",
      "description": "Drawing revision history",
      "items": {
        "type": "object",
        "properties": {
          "revision_mark": {
            "type": "string",
            "pattern": "^[A-Z0-9]{1,3}$"
          },
          "date": {
            "type": "string",
            "format": "date"
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "revised_by": {
            "type": "string"
          },
          "approved_by": {
            "type": "string"
          },
          "change_type": {
            "type": "string",
            "enum": ["addition", "deletion", "modification", "correction", "clarification"]
          }
        },
        "required": ["revision_mark", "date", "description", "revised_by"]
      }
    },
    "diffs": {
      "type": "array",
      "description": "Visual comparison between revisions",
      "items": {
        "type": "object",
        "properties": {
          "from_revision": {
            "type": "string"
          },
          "to_revision": {
            "type": "string"
          },
          "diff_image_path": {
            "type": "string",
            "description": "Path to difference visualization image"
          },
          "change_summary": {
            "type": "string"
          },
          "impact_assessment": {
            "type": "object",
            "properties": {
              "cost_impact": {
                "type": "string",
                "enum": ["none", "low", "medium", "high"]
              },
              "schedule_impact": {
                "type": "string",
                "enum": ["none", "low", "medium", "high"]
              },
              "risk_level": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              }
            }
          },
          "generated_timestamp": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": ["from_revision", "to_revision", "diff_image_path", "change_summary"]
      }
    },
    "estimate_binding": {
      "type": "object",
      "description": "Links to related estimate items",
      "properties": {
        "estimate_id": {
          "type": "string",
          "pattern": "^EST-[0-9]{8}-[A-Z0-9]{6}$"
        },
        "bound_items": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "bom_item_number": {
                "type": "string"
              },
              "estimate_item_id": {
                "type": "string"
              },
              "binding_confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["bom_item_number", "estimate_item_id"]
          }
        }
      }
    },
    "evidence": {
      "type": "object",
      "description": "Evidence tracking for audit trail",
      "properties": {
        "extraction_method": {
          "type": "string",
          "enum": ["ocr", "ai_vision", "manual", "hybrid"]
        },
        "processing_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "evidence_snapshots": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Paths to PNG/SVG evidence files"
          }
        },
        "quality_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "validation_status": {
          "type": "string",
          "enum": ["pending", "validated", "requires_review", "rejected"]
        }
      },
      "required": ["extraction_method", "processing_timestamp", "quality_score"]
    },
    "audit_trail": {
      "type": "object",
      "properties": {
        "created_by": {
          "type": "string"
        },
        "created_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "last_modified_by": {
          "type": "string"
        },
        "last_modified_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "work_id": {
          "type": "string",
          "description": "Reference to work session identifier"
        },
        "input_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "output_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        }
      },
      "required": ["created_by", "created_timestamp", "work_id"]
    }
  },
  "required": ["drawing_id", "version", "metadata", "files", "bom", "dimensions", "revisions", "evidence", "audit_trail"]
}