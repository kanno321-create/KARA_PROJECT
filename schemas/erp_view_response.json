{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://kis-core.com/schemas/erp_view_response.json",
  "title": "ERP View Response Schema",
  "description": "Response schema for ERP data queries with evidence links and executive summary",
  "type": "object",
  "properties": {
    "response_id": {
      "type": "string",
      "pattern": "^RES-[0-9]{8}-[A-Z0-9]{6}$",
      "description": "Unique response identifier"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "request_id": {
      "type": "string",
      "pattern": "^REQ-[0-9]{8}-[A-Z0-9]{6}$",
      "description": "Reference to original request"
    },
    "status": {
      "type": "object",
      "properties": {
        "execution_status": {
          "type": "string",
          "enum": ["success", "partial_success", "failed", "timeout"]
        },
        "http_status_code": {
          "type": "integer",
          "minimum": 100,
          "maximum": 599
        },
        "message": {
          "type": "string",
          "description": "Human-readable status message"
        },
        "errors": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "error_code": {
                "type": "string"
              },
              "error_message": {
                "type": "string"
              },
              "error_context": {
                "type": "string"
              }
            },
            "required": ["error_code", "error_message"]
          }
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "warning_code": {
                "type": "string"
              },
              "warning_message": {
                "type": "string"
              }
            },
            "required": ["warning_code", "warning_message"]
          }
        }
      },
      "required": ["execution_status", "http_status_code", "message"]
    },
    "executive_summary": {
      "type": "object",
      "description": "5-line executive summary with key insights",
      "properties": {
        "summary_lines": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "maxItems": 5,
          "description": "Executive summary in 1-5 lines"
        },
        "key_metrics": {
          "type": "object",
          "properties": {
            "total_records": {
              "type": "integer",
              "minimum": 0
            },
            "total_amount": {
              "type": "number",
              "description": "Total financial amount in KRW"
            },
            "date_range_covered": {
              "type": "object",
              "properties": {
                "start_date": {
                  "type": "string",
                  "format": "date"
                },
                "end_date": {
                  "type": "string",
                  "format": "date"
                }
              }
            },
            "data_quality_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "critical_findings": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "maxItems": 3,
          "description": "Up to 3 most critical findings"
        },
        "risk_alerts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "risk_type": {
                "type": "string",
                "enum": ["liquidity", "credit", "operational", "compliance"]
              },
              "severity": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              },
              "description": {
                "type": "string"
              }
            },
            "required": ["risk_type", "severity", "description"]
          },
          "maxItems": 5
        }
      },
      "required": ["summary_lines", "key_metrics"]
    },
    "data": {
      "type": "object",
      "properties": {
        "records": {
          "type": "array",
          "items": {
            "type": "object",
            "description": "Data records matching the query",
            "additionalProperties": true
          }
        },
        "aggregations": {
          "type": "object",
          "properties": {
            "totals": {
              "type": "object",
              "additionalProperties": {
                "type": "number"
              }
            },
            "averages": {
              "type": "object",
              "additionalProperties": {
                "type": "number"
              }
            },
            "counts": {
              "type": "object",
              "additionalProperties": {
                "type": "integer"
              }
            },
            "groupings": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "count": {
                    "type": "integer"
                  },
                  "total": {
                    "type": "number"
                  },
                  "average": {
                    "type": "number"
                  }
                }
              }
            }
          }
        },
        "pagination": {
          "type": "object",
          "properties": {
            "page": {
              "type": "integer",
              "minimum": 1
            },
            "page_size": {
              "type": "integer",
              "minimum": 1
            },
            "total_records": {
              "type": "integer",
              "minimum": 0
            },
            "total_pages": {
              "type": "integer",
              "minimum": 0
            },
            "has_next_page": {
              "type": "boolean"
            },
            "has_previous_page": {
              "type": "boolean"
            }
          }
        }
      },
      "required": ["records"]
    },
    "kpi_results": {
      "type": "object",
      "description": "KPI calculations if requested",
      "properties": {
        "dso": {
          "type": "object",
          "properties": {
            "value": {
              "type": "number",
              "minimum": 0
            },
            "interpretation": {
              "type": "string",
              "enum": ["excellent", "good", "fair", "poor", "critical"]
            },
            "benchmark_comparison": {
              "type": "string",
              "enum": ["above_benchmark", "at_benchmark", "below_benchmark"]
            }
          }
        },
        "dpo": {
          "type": "object",
          "properties": {
            "value": {
              "type": "number",
              "minimum": 0
            },
            "interpretation": {
              "type": "string",
              "enum": ["excellent", "good", "fair", "poor", "critical"]
            },
            "benchmark_comparison": {
              "type": "string",
              "enum": ["above_benchmark", "at_benchmark", "below_benchmark"]
            }
          }
        },
        "inventory_days": {
          "type": "object",
          "properties": {
            "value": {
              "type": "number",
              "minimum": 0
            },
            "interpretation": {
              "type": "string",
              "enum": ["excellent", "good", "fair", "poor", "critical"]
            },
            "benchmark_comparison": {
              "type": "string",
              "enum": ["above_benchmark", "at_benchmark", "below_benchmark"]
            }
          }
        },
        "ccc": {
          "type": "object",
          "properties": {
            "value": {
              "type": "number",
              "description": "Cash conversion cycle in days (can be negative)"
            },
            "interpretation": {
              "type": "string",
              "enum": ["excellent", "good", "fair", "poor", "critical"]
            },
            "cash_flow_impact": {
              "type": "string",
              "enum": ["very_positive", "positive", "neutral", "negative", "very_negative"]
            }
          }
        },
        "liquidity_ratios": {
          "type": "object",
          "properties": {
            "current_ratio": {
              "type": "number",
              "minimum": 0
            },
            "quick_ratio": {
              "type": "number",
              "minimum": 0
            },
            "cash_ratio": {
              "type": "number",
              "minimum": 0
            }
          }
        },
        "trend_analysis": {
          "type": "object",
          "properties": {
            "period_comparisons": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "period": {
                    "type": "string"
                  },
                  "kpi_name": {
                    "type": "string"
                  },
                  "value": {
                    "type": "number"
                  },
                  "change_percentage": {
                    "type": "number"
                  },
                  "trend_direction": {
                    "type": "string",
                    "enum": ["improving", "stable", "deteriorating"]
                  }
                },
                "required": ["period", "kpi_name", "value", "trend_direction"]
              }
            }
          }
        }
      }
    },
    "evidence_links": {
      "type": "object",
      "description": "Links to evidence files and supporting documentation",
      "properties": {
        "source_data_files": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "file_type": {
                "type": "string",
                "enum": ["csv", "json", "excel", "pdf"]
              },
              "file_path": {
                "type": "string",
                "description": "Relative path to evidence folder"
              },
              "description": {
                "type": "string"
              },
              "hash": {
                "type": "string",
                "pattern": "^[a-f0-9]{64}$"
              },
              "file_size": {
                "type": "integer",
                "minimum": 0
              },
              "created_timestamp": {
                "type": "string",
                "format": "date-time"
              }
            },
            "required": ["file_type", "file_path", "description", "hash"]
          }
        },
        "calculation_worksheets": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "worksheet_type": {
                "type": "string",
                "enum": ["kpi_calculation", "aggregation", "reconciliation", "validation"]
              },
              "file_path": {
                "type": "string"
              },
              "description": {
                "type": "string"
              },
              "hash": {
                "type": "string",
                "pattern": "^[a-f0-9]{64}$"
              }
            },
            "required": ["worksheet_type", "file_path", "description", "hash"]
          }
        },
        "visualization_charts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "chart_type": {
                "type": "string",
                "enum": ["bar", "line", "pie", "scatter", "trend", "dashboard"]
              },
              "file_path": {
                "type": "string",
                "description": "Path to PNG/SVG chart file"
              },
              "title": {
                "type": "string"
              },
              "description": {
                "type": "string"
              }
            },
            "required": ["chart_type", "file_path", "title"]
          }
        },
        "audit_reports": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "report_type": {
                "type": "string",
                "enum": ["data_quality", "reconciliation", "variance_analysis", "exception_report"]
              },
              "file_path": {
                "type": "string"
              },
              "summary": {
                "type": "string"
              }
            },
            "required": ["report_type", "file_path", "summary"]
          }
        }
      }
    },
    "next_actions": {
      "type": "object",
      "description": "Recommended next 3 actions",
      "properties": {
        "recommended_actions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "action_id": {
                "type": "string"
              },
              "title": {
                "type": "string",
                "minLength": 1
              },
              "description": {
                "type": "string"
              },
              "priority": {
                "type": "string",
                "enum": ["low", "medium", "high", "urgent"]
              },
              "estimated_effort": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              },
              "expected_impact": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              },
              "timeline": {
                "type": "string",
                "description": "Recommended timeline for action"
              },
              "dependencies": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "related_kpis": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["dso", "dpo", "inventory_days", "ccc", "liquidity"]
                }
              }
            },
            "required": ["action_id", "title", "priority"]
          },
          "minItems": 1,
          "maxItems": 3
        },
        "follow_up_queries": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "query_description": {
                "type": "string"
              },
              "expected_insight": {
                "type": "string"
              },
              "suggested_filters": {
                "type": "object",
                "additionalProperties": true
              }
            },
            "required": ["query_description", "expected_insight"]
          },
          "maxItems": 3
        }
      },
      "required": ["recommended_actions"]
    },
    "performance_metrics": {
      "type": "object",
      "properties": {
        "execution_time_ms": {
          "type": "integer",
          "minimum": 0
        },
        "data_processing_time_ms": {
          "type": "integer",
          "minimum": 0
        },
        "records_processed": {
          "type": "integer",
          "minimum": 0
        },
        "cache_hit_ratio": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "memory_usage_mb": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "response_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "processing_duration": {
          "type": "string",
          "description": "ISO 8601 duration format"
        },
        "data_freshness": {
          "type": "object",
          "properties": {
            "last_updated": {
              "type": "string",
              "format": "date-time"
            },
            "staleness_minutes": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "system_info": {
          "type": "object",
          "properties": {
            "processor_version": {
              "type": "string"
            },
            "database_version": {
              "type": "string"
            },
            "api_version": {
              "type": "string"
            }
          }
        }
      },
      "required": ["response_timestamp"]
    },
    "audit_trail": {
      "type": "object",
      "properties": {
        "processed_by": {
          "type": "string"
        },
        "processed_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "work_id": {
          "type": "string"
        },
        "query_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "Hash of the original query parameters"
        },
        "result_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "Hash of the result data"
        },
        "evidence_index_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "Hash of evidence files index"
        }
      },
      "required": ["processed_by", "processed_timestamp", "work_id", "query_hash", "result_hash"]
    }
  },
  "required": [
    "response_id",
    "version",
    "request_id",
    "status",
    "executive_summary",
    "data",
    "evidence_links",
    "next_actions",
    "metadata",
    "audit_trail"
  ]
}