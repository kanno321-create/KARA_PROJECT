{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://kis-core.com/schemas/estimate_response.json",
  "title": "Estimate Response Schema",
  "description": "Response schema for AI-powered estimation with change impact analysis",
  "type": "object",
  "properties": {
    "response_id": {
      "type": "string",
      "pattern": "^RES-[0-9]{8}-[A-Z0-9]{6}$",
      "description": "Unique estimate response identifier"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "request_id": {
      "type": "string",
      "pattern": "^REQ-[0-9]{8}-[A-Z0-9]{6}$",
      "description": "Reference to original request"
    },
    "estimate_id": {
      "type": "string",
      "pattern": "^EST-[0-9]{8}-[A-Z0-9]{6}$",
      "description": "Generated estimate identifier"
    },
    "status": {
      "type": "object",
      "properties": {
        "processing_status": {
          "type": "string",
          "enum": ["success", "partial_success", "failed", "requires_review"]
        },
        "confidence_level": {
          "type": "string",
          "enum": ["high", "medium", "low", "insufficient_data"]
        },
        "ai_contribution": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Percentage of estimate generated by AI vs traditional methods"
        },
        "validation_status": {
          "type": "string",
          "enum": ["auto_validated", "requires_human_review", "expert_review_needed"]
        },
        "quality_gates": {
          "type": "object",
          "properties": {
            "completeness_check": {
              "type": "boolean"
            },
            "consistency_check": {
              "type": "boolean"
            },
            "reasonableness_check": {
              "type": "boolean"
            },
            "benchmark_validation": {
              "type": "boolean"
            }
          },
          "required": ["completeness_check", "consistency_check", "reasonableness_check"]
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "warning_type": {
                "type": "string",
                "enum": ["low_confidence", "incomplete_data", "outlier_detected", "assumption_risk"]
              },
              "message": {
                "type": "string"
              },
              "severity": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              }
            },
            "required": ["warning_type", "message", "severity"]
          }
        }
      },
      "required": ["processing_status", "confidence_level", "ai_contribution", "validation_status", "quality_gates"]
    },
    "estimate_summary": {
      "type": "object",
      "properties": {
        "total_cost": {
          "type": "object",
          "properties": {
            "base_cost": {
              "type": "number",
              "minimum": 0,
              "description": "Base cost without contingencies in KRW"
            },
            "contingency": {
              "type": "number",
              "minimum": 0,
              "description": "Contingency amount in KRW"
            },
            "escalation": {
              "type": "number",
              "minimum": 0,
              "description": "Escalation allowance in KRW"
            },
            "total_including_contingency": {
              "type": "number",
              "minimum": 0,
              "description": "Total cost including all allowances in KRW"
            },
            "currency": {
              "type": "string",
              "pattern": "^[A-Z]{3}$",
              "default": "KRW"
            }
          },
          "required": ["base_cost", "contingency", "total_including_contingency", "currency"]
        },
        "cost_breakdown": {
          "type": "object",
          "properties": {
            "materials": {
              "type": "number",
              "minimum": 0
            },
            "labor": {
              "type": "number",
              "minimum": 0
            },
            "equipment": {
              "type": "number",
              "minimum": 0
            },
            "subcontractors": {
              "type": "number",
              "minimum": 0
            },
            "overhead": {
              "type": "number",
              "minimum": 0
            },
            "profit": {
              "type": "number",
              "minimum": 0
            }
          },
          "required": ["materials", "labor", "equipment", "overhead"]
        },
        "schedule_estimate": {
          "type": "object",
          "properties": {
            "estimated_duration_months": {
              "type": "number",
              "minimum": 0
            },
            "critical_path_duration": {
              "type": "number",
              "minimum": 0
            },
            "schedule_confidence": {
              "type": "string",
              "enum": ["high", "medium", "low"]
            },
            "key_milestones": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "milestone_name": {
                    "type": "string"
                  },
                  "estimated_date": {
                    "type": "string",
                    "format": "date"
                  },
                  "critical": {
                    "type": "boolean"
                  }
                },
                "required": ["milestone_name", "estimated_date"]
              }
            }
          },
          "required": ["estimated_duration_months", "schedule_confidence"]
        },
        "accuracy_range": {
          "type": "object",
          "properties": {
            "low_estimate": {
              "type": "number",
              "minimum": 0,
              "description": "Optimistic estimate (-X%)"
            },
            "high_estimate": {
              "type": "number",
              "minimum": 0,
              "description": "Pessimistic estimate (+Y%)"
            },
            "confidence_interval": {
              "type": "string",
              "enum": ["90%", "95%", "99%"]
            },
            "accuracy_class": {
              "type": "string",
              "enum": ["class_5", "class_4", "class_3", "class_2", "class_1"],
              "description": "AACE accuracy classification"
            }
          },
          "required": ["low_estimate", "high_estimate", "confidence_interval", "accuracy_class"]
        }
      },
      "required": ["total_cost", "cost_breakdown", "schedule_estimate", "accuracy_range"]
    },
    "detailed_breakdown": {
      "type": "object",
      "properties": {
        "work_packages": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "wbs_code": {
                "type": "string",
                "pattern": "^[0-9]+(\\.[0-9]+)*$"
              },
              "work_package_name": {
                "type": "string"
              },
              "cost_estimate": {
                "type": "number",
                "minimum": 0
              },
              "duration_estimate": {
                "type": "number",
                "minimum": 0,
                "description": "Duration in days"
              },
              "resource_requirements": {
                "type": "object",
                "properties": {
                  "labor_hours": {
                    "type": "number",
                    "minimum": 0
                  },
                  "equipment_hours": {
                    "type": "number",
                    "minimum": 0
                  },
                  "skill_requirements": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "skill_category": {
                          "type": "string",
                          "enum": ["engineer", "technician", "welder", "electrician", "machinist", "project_manager"]
                        },
                        "hours_required": {
                          "type": "number",
                          "minimum": 0
                        },
                        "skill_level": {
                          "type": "string",
                          "enum": ["junior", "mid", "senior", "expert"]
                        }
                      },
                      "required": ["skill_category", "hours_required", "skill_level"]
                    }
                  }
                }
              },
              "risk_assessment": {
                "type": "object",
                "properties": {
                  "risk_level": {
                    "type": "string",
                    "enum": ["low", "medium", "high", "critical"]
                  },
                  "risk_factors": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "mitigation_strategies": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              },
              "ai_confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "description": "AI confidence score for this work package"
              },
              "estimation_method": {
                "type": "string",
                "enum": ["ai_generated", "historical_data", "expert_judgment", "parametric", "vendor_quote"]
              }
            },
            "required": ["wbs_code", "work_package_name", "cost_estimate", "duration_estimate", "ai_confidence", "estimation_method"]
          }
        },
        "material_takeoff": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "item_code": {
                "type": "string"
              },
              "description": {
                "type": "string"
              },
              "quantity": {
                "type": "number",
                "minimum": 0
              },
              "unit": {
                "type": "string",
                "enum": ["ea", "m", "m2", "m3", "kg", "ton", "set", "lot"]
              },
              "unit_cost": {
                "type": "number",
                "minimum": 0
              },
              "total_cost": {
                "type": "number",
                "minimum": 0
              },
              "supplier_info": {
                "type": "object",
                "properties": {
                  "preferred_supplier": {
                    "type": "string"
                  },
                  "lead_time_days": {
                    "type": "number",
                    "minimum": 0
                  },
                  "price_validity_date": {
                    "type": "string",
                    "format": "date"
                  }
                }
              },
              "source": {
                "type": "string",
                "enum": ["drawing_extraction", "bom_database", "ai_inference", "manual_input", "vendor_quote"]
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["item_code", "description", "quantity", "unit", "unit_cost", "total_cost", "source", "confidence"]
          }
        }
      },
      "required": ["work_packages"]
    },
    "ai_insights": {
      "type": "object",
      "description": "AI-generated insights and reasoning",
      "properties": {
        "estimation_methodology": {
          "type": "object",
          "properties": {
            "primary_method": {
              "type": "string",
              "enum": ["neural_network", "regression_analysis", "similarity_matching", "ensemble_method"]
            },
            "training_data_quality": {
              "type": "string",
              "enum": ["excellent", "good", "fair", "limited"]
            },
            "comparable_projects_count": {
              "type": "integer",
              "minimum": 0
            },
            "feature_importance": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "feature_name": {
                    "type": "string"
                  },
                  "importance_score": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1
                  }
                },
                "required": ["feature_name", "importance_score"]
              }
            }
          },
          "required": ["primary_method", "training_data_quality"]
        },
        "key_assumptions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "assumption": {
                "type": "string"
              },
              "impact_level": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["assumption", "impact_level", "confidence"]
          }
        },
        "anomaly_detection": {
          "type": "object",
          "properties": {
            "outliers_detected": {
              "type": "boolean"
            },
            "outlier_details": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "item": {
                    "type": "string"
                  },
                  "expected_range": {
                    "type": "string"
                  },
                  "actual_value": {
                    "type": "number"
                  },
                  "deviation_score": {
                    "type": "number",
                    "minimum": 0
                  }
                },
                "required": ["item", "actual_value", "deviation_score"]
              }
            }
          }
        },
        "recommendations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "recommendation_type": {
                "type": "string",
                "enum": ["cost_optimization", "schedule_optimization", "risk_mitigation", "quality_improvement"]
              },
              "description": {
                "type": "string"
              },
              "potential_savings": {
                "type": "number",
                "minimum": 0
              },
              "implementation_effort": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              }
            },
            "required": ["recommendation_type", "description"]
          }
        }
      }
    },
    "sensitivity_analysis": {
      "type": "object",
      "description": "Sensitivity scenarios if requested",
      "properties": {
        "base_scenario": {
          "type": "object",
          "properties": {
            "scenario_name": {
              "type": "string",
              "default": "Base Case"
            },
            "total_cost": {
              "type": "number",
              "minimum": 0
            },
            "duration_months": {
              "type": "number",
              "minimum": 0
            },
            "probability": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          },
          "required": ["scenario_name", "total_cost", "duration_months"]
        },
        "alternative_scenarios": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "scenario_name": {
                "type": "string"
              },
              "scenario_type": {
                "type": "string",
                "enum": ["optimistic", "pessimistic", "scope_change", "schedule_compression"]
              },
              "key_changes": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "cost_impact": {
                "type": "object",
                "properties": {
                  "absolute_change": {
                    "type": "number"
                  },
                  "percentage_change": {
                    "type": "number"
                  },
                  "new_total_cost": {
                    "type": "number",
                    "minimum": 0
                  }
                },
                "required": ["absolute_change", "percentage_change", "new_total_cost"]
              },
              "schedule_impact": {
                "type": "object",
                "properties": {
                  "duration_change_months": {
                    "type": "number"
                  },
                  "new_duration_months": {
                    "type": "number",
                    "minimum": 0
                  }
                },
                "required": ["duration_change_months", "new_duration_months"]
              },
              "probability": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["scenario_name", "scenario_type", "cost_impact", "schedule_impact"]
          }
        }
      },
      "required": ["base_scenario"]
    },
    "change_impact": {
      "type": "object",
      "description": "Change impact analysis as specified in requirements",
      "$ref": "change_impact.json"
    },
    "evidence_package": {
      "type": "object",
      "properties": {
        "source_documents": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "document_type": {
                "type": "string",
                "enum": ["drawing", "specification", "vendor_quote", "historical_estimate"]
              },
              "file_path": {
                "type": "string"
              },
              "hash": {
                "type": "string",
                "pattern": "^[a-f0-9]{64}$"
              },
              "extraction_confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            },
            "required": ["document_type", "file_path", "hash"]
          }
        },
        "calculation_worksheets": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Paths to CSV/JSON calculation files"
          }
        },
        "visualization_charts": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Paths to PNG/SVG chart files"
          }
        },
        "validation_reports": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Paths to validation and QA reports"
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "response_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "processing_duration": {
          "type": "string",
          "description": "ISO 8601 duration format"
        },
        "processor_info": {
          "type": "object",
          "properties": {
            "ai_model_version": {
              "type": "string"
            },
            "estimation_engine_version": {
              "type": "string"
            },
            "database_version": {
              "type": "string"
            }
          }
        },
        "quality_metrics": {
          "type": "object",
          "properties": {
            "completeness_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "consistency_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "accuracy_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        }
      },
      "required": ["response_timestamp"]
    },
    "audit_trail": {
      "type": "object",
      "properties": {
        "processed_by": {
          "type": "string"
        },
        "processed_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "work_id": {
          "type": "string"
        },
        "request_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "output_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "evidence_index_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        }
      },
      "required": ["processed_by", "processed_timestamp", "work_id", "request_hash", "output_hash"]
    }
  },
  "required": [
    "response_id",
    "version",
    "request_id",
    "estimate_id",
    "status",
    "estimate_summary",
    "detailed_breakdown",
    "ai_insights",
    "change_impact",
    "evidence_package",
    "metadata",
    "audit_trail"
  ]
}