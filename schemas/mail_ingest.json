{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MailIngest",
  "type": "object",
  "required": ["msg_id", "from", "subject", "body", "intent", "tasks"],
  "properties": {
    "msg_id": {
      "type": "string",
      "pattern": "^MSG-[0-9]{8}-[A-Z0-9]{8}$"
    },
    "from": {
      "type": "object",
      "properties": {
        "email": {"type": "string", "format": "email"},
        "name": {"type": "string"},
        "company": {"type": "string"},
        "department": {"type": "string"}
      },
      "required": ["email"]
    },
    "to": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "email": {"type": "string", "format": "email"},
          "name": {"type": "string"},
          "type": {"type": "string", "enum": ["to", "cc", "bcc"]}
        }
      }
    },
    "subject": {
      "type": "string",
      "minLength": 1,
      "maxLength": 500
    },
    "body": {
      "type": "object",
      "properties": {
        "plain": {"type": "string"},
        "html": {"type": "string"},
        "extracted_text": {"type": "string"}
      }
    },
    "attachments": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "filename": {"type": "string"},
          "mime_type": {"type": "string"},
          "size_bytes": {"type": "integer"},
          "path": {"type": "string"},
          "hash": {"type": "string"},
          "extracted": {
            "type": "object",
            "properties": {
              "type": {"type": "string", "enum": ["drawing", "estimate", "invoice", "spec", "other"]},
              "content": {"type": "object"}
            }
          }
        },
        "required": ["filename", "mime_type", "size_bytes"]
      }
    },
    "intent": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "category": {
            "type": "string",
            "enum": ["estimate_request", "delivery_change", "drawing_revision", "invoice", "payment", "complaint", "inquiry", "order", "cancellation"]
          },
          "confidence": {"type": "number", "minimum": 0, "maximum": 1},
          "keywords": {"type": "array", "items": {"type": "string"}},
          "urgency": {"type": "string", "enum": ["low", "medium", "high", "critical"]}
        },
        "required": ["category", "confidence"]
      }
    },
    "extractions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "field": {"type": "string"},
          "value": {},
          "confidence": {"type": "number"},
          "source": {"type": "string", "enum": ["subject", "body", "attachment"]},
          "evidence_path": {"type": "string"}
        }
      }
    },
    "tasks": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "task_id": {"type": "string"},
          "tab": {"type": "string", "enum": ["estimate", "erp", "calendar", "drawing", "ai_manager"]},
          "action": {"type": "string"},
          "priority": {"type": "integer", "minimum": 1, "maximum": 5},
          "due_date": {"type": "string", "format": "date-time"},
          "assignee": {"type": "string"},
          "status": {"type": "string", "enum": ["pending", "assigned", "in_progress", "completed", "failed"]},
          "parameters": {"type": "object"},
          "evidence": {"type": "array", "items": {"type": "string"}}
        },
        "required": ["task_id", "tab", "action", "priority", "status"]
      }
    },
    "processing": {
      "type": "object",
      "properties": {
        "received_at": {"type": "string", "format": "date-time"},
        "processed_at": {"type": "string", "format": "date-time"},
        "processing_time_ms": {"type": "integer"},
        "ai_models_used": {"type": "array", "items": {"type": "string"}},
        "errors": {"type": "array", "items": {"type": "string"}}
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "thread_id": {"type": "string"},
        "references": {"type": "array", "items": {"type": "string"}},
        "labels": {"type": "array", "items": {"type": "string"}},
        "importance": {"type": "string", "enum": ["low", "normal", "high"]},
        "spam_score": {"type": "number", "minimum": 0, "maximum": 1}
      }
    }
  }
}