{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://kis-core.com/schemas/estimates.schema.json",
  "title": "KIS Core Estimates Schema",
  "description": "Validation schema for estimate data structures in KIS Core system",
  "type": "object",
  "properties": {
    "estimate": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^EST-[0-9]{8}-[A-Z0-9]{6}$",
          "description": "Unique estimate identifier"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+$"
        },
        "metadata": {
          "type": "object",
          "properties": {
            "created": {
              "type": "string",
              "format": "date-time"
            },
            "updated": {
              "type": "string",
              "format": "date-time"
            },
            "createdBy": {
              "type": "string"
            },
            "project": {
              "type": "string"
            },
            "customer": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "minLength": 1
                },
                "code": {
                  "type": "string",
                  "pattern": "^[A-Z0-9]{3,10}$"
                },
                "contact": {
                  "type": "object",
                  "properties": {
                    "email": {
                      "type": "string",
                      "format": "email"
                    },
                    "phone": {
                      "type": "string"
                    }
                  }
                }
              },
              "required": ["name", "code"]
            }
          },
          "required": ["created", "createdBy", "project", "customer"]
        },
        "items": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string"
              },
              "type": {
                "type": "string",
                "enum": ["material", "labor", "equipment", "service", "overhead"]
              },
              "description": {
                "type": "string",
                "minLength": 1
              },
              "category": {
                "type": "string"
              },
              "subcategory": {
                "type": "string"
              },
              "unit": {
                "type": "string",
                "enum": ["ea", "m", "m2", "m3", "kg", "hr", "day", "set", "lot"]
              },
              "quantity": {
                "type": "number",
                "minimum": 0
              },
              "unitPrice": {
                "type": "number",
                "minimum": 0
              },
              "totalPrice": {
                "type": "number",
                "minimum": 0
              },
              "laborHours": {
                "type": "number",
                "minimum": 0
              },
              "complexity": {
                "type": "string",
                "enum": ["low", "medium", "high", "expert"]
              },
              "riskFactor": {
                "type": "number",
                "minimum": 0,
                "maximum": 2
              },
              "markup": {
                "type": "object",
                "properties": {
                  "percentage": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100
                  },
                  "type": {
                    "type": "string",
                    "enum": ["profit", "overhead", "contingency"]
                  }
                }
              },
              "aiGenerated": {
                "type": "boolean",
                "description": "Whether this item was generated by AI"
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "description": "AI confidence score for this item"
              }
            },
            "required": ["id", "type", "description", "unit", "quantity", "unitPrice", "totalPrice"]
          },
          "minItems": 1
        },
        "summary": {
          "type": "object",
          "properties": {
            "subtotal": {
              "type": "number",
              "minimum": 0
            },
            "tax": {
              "type": "object",
              "properties": {
                "rate": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                },
                "amount": {
                  "type": "number",
                  "minimum": 0
                }
              },
              "required": ["rate", "amount"]
            },
            "discount": {
              "type": "object",
              "properties": {
                "rate": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                },
                "amount": {
                  "type": "number",
                  "minimum": 0
                }
              }
            },
            "total": {
              "type": "number",
              "minimum": 0
            },
            "currency": {
              "type": "string",
              "pattern": "^[A-Z]{3}$",
              "default": "KRW"
            }
          },
          "required": ["subtotal", "tax", "total", "currency"]
        },
        "validation": {
          "type": "object",
          "properties": {
            "status": {
              "type": "string",
              "enum": ["draft", "validated", "approved", "rejected"]
            },
            "accuracy": {
              "type": "object",
              "properties": {
                "errorRate": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                },
                "method": {
                  "type": "string",
                  "enum": ["historical", "expert", "benchmark", "ai"]
                }
              }
            },
            "qualityGates": {
              "type": "object",
              "properties": {
                "completeness": {
                  "type": "boolean"
                },
                "consistency": {
                  "type": "boolean"
                },
                "reasonableness": {
                  "type": "boolean"
                }
              }
            }
          },
          "required": ["status"]
        }
      },
      "required": ["id", "version", "metadata", "items", "summary", "validation"]
    }
  },
  "required": ["estimate"]
}