<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KIS ERP System - Complete</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --color-brand: #10a37f;
    --color-brand-strong: #0e8f71;
    --color-surface: #ffffff;
    --color-surface-2: #f2f2f2;
    --color-text: #1f2328;
    --color-text-subtle: #6b7280;
    --color-border: #e5e7eb;
    --color-error: #ef4444;
    --color-warning: #f59e0b;
    --color-success: #10b981;
}

body {
    font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
    background: #f7f7f8;
    color: var(--color-text);
}

.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

/* íƒ­ ì‹œìŠ¤í…œ */
.tab-container {
    background: white;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 8px;
    overflow-x: auto;
}

.tab {
    padding: 10px 16px;
    border: 1px solid #d1d1d1;
    border-bottom: none;
    background: #f9f9f9;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    border-radius: 4px 4px 0 0;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tab.active {
    background: white;
    border-color: var(--color-brand);
    color: var(--color-brand);
}

.tab-close {
    margin-left: 4px;
    cursor: pointer;
    color: #999;
    width: 16px;
    height: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.tab-close:hover {
    background: #e1dfdd;
    border-radius: 50%;
}

.new-tab {
    padding: 6px 10px;
    background: var(--color-brand);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}

.new-tab:hover {
    background: var(--color-brand-strong);
}

/* ìƒˆ íƒ­ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
.new-tab-dropdown {
    position: relative;
    display: inline-block;
}

.new-tab-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
    z-index: 1000;
    min-width: 120px;
}

.new-tab-menu.show {
    display: block;
}

.new-tab-menu-item {
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s;
}

.new-tab-menu-item:hover {
    background: #f0f0f0;
}

/* ë©”ì¸ ì½˜í…ì¸  */
.content-container {
    flex: 1;
    display: flex;
    overflow: hidden;
}

.left-panel {
    width: 500px;
    background: white;
    padding: 20px;
    overflow-y: auto;
    border-right: 1px solid var(--color-border);
}

.right-panel {
    flex: 1;
    background: white;
    padding: 20px;
    overflow-y: auto;
}

/* ì„¹ì…˜ ì¹´ë“œ */
.section {
    margin-bottom: 20px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: white;
}

.section-header {
    background: #f9f9f9;
    padding: 12px 16px;
    border-bottom: 1px solid var(--color-border);
    font-weight: 600;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-content {
    padding: 16px;
}

/* í¼ ìš”ì†Œ */
.form-row {
    margin-bottom: 12px;
}

.form-row.cols-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.form-label {
    display: block;
    font-size: 13px;
    color: var(--color-text-subtle);
    margin-bottom: 4px;
    font-weight: 500;
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d1d1;
    border-radius: 2px;
    font-size: 14px;
    background: white;
}

.form-textarea {
    min-height: 80px;
    resize: vertical;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--color-brand);
}

/* ë²„íŠ¼ */
.btn {
    padding: 8px 16px;
    border: 1px solid #d1d1d1;
    border-radius: 2px;
    background: white;
    color: #323130;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.btn:hover {
    background: #f3f2f1;
}

.btn-primary {
    background: var(--color-brand);
    color: white;
    border-color: var(--color-brand);
}

.btn-primary:hover {
    background: var(--color-brand-strong);
}

.btn-small {
    padding: 4px 8px;
    font-size: 12px;
}

/* í† ê¸€ */
.header-toggle {
    display: flex;
    background: #f0f0f0;
    border-radius: 20px;
    padding: 2px;
    border: 1px solid #d1d1d1;
}

.header-toggle-option {
    padding: 4px 12px;
    border-radius: 18px;
    background: transparent;
    color: #666;
    border: none;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}

.header-toggle-option.active {
    background: var(--color-brand);
    color: white;
}

/* ë¦¬ìŠ¤íŠ¸ */
.item-list {
    border: 1px solid var(--color-border);
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
}

.list-item {
    padding: 8px 12px;
    border-bottom: 1px solid #f3f2f1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

.list-item:hover {
    background: #f9f9f9;
}

.list-empty {
    padding: 20px;
    text-align: center;
    color: #999;
    font-style: italic;
}

/* ë°°ë„ˆ */
.banner {
    padding: 8px 16px;
    border-radius: 4px;
    margin-bottom: 12px;
    font-size: 13px;
    animation: slideDown 0.3s ease;
}

.banner.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
}

.banner.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

.banner.warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* í…Œì´ë¸” */
table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
    font-size: 13px;
}

th {
    background: #f9f9f9;
    font-weight: 600;
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    color: var(--color-text-subtle);
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

/* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
.calendar-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f9f9f9;
    border-bottom: 1px solid var(--color-border);
}

.calendar-nav-btn {
    padding: 6px 12px;
    border: 1px solid var(--color-border);
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.calendar-nav-btn:hover {
    background: #f0f0f0;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    border: 1px solid var(--color-border);
}

.calendar-header-cell {
    padding: 8px;
    background: #f9f9f9;
    text-align: center;
    font-weight: 600;
    font-size: 12px;
    border-right: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
}

.calendar-cell {
    min-height: 80px;
    padding: 4px;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
    background: white;
}

.calendar-cell.other-month {
    background: #f9f9f9;
    color: #999;
}

.calendar-cell.today {
    background: #f0fdf4;
}

.calendar-day {
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 4px;
}

.calendar-event {
    font-size: 11px;
    padding: 2px 4px;
    margin: 1px 0;
    border-radius: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
}

.calendar-event.estimate { background: #dbeafe; color: #1e40af; }
.calendar-event.install { background: #fce7f3; color: #9f1239; }
.calendar-event.inbound { background: #f3e8ff; color: #6b21a8; }
.calendar-event.misc { background: #e0e7ff; color: #4338ca; }

/* ì´ë©”ì¼ ìŠ¤íƒ€ì¼ */
.email-thread {
    padding: 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.email-thread:hover {
    background: #f9f9f9;
}

.email-thread.selected {
    border-color: var(--color-brand);
    background: #f0fdf4;
}

.email-status {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.email-status.sent { background: #d1fae5; color: #065f46; }
.email-status.draft { background: #e0e7ff; color: #4338ca; }
.email-status.failed { background: #fee2e2; color: #991b1b; }

.email-group-badge {
    display: inline-block;
    padding: 2px 8px;
    background: var(--color-brand);
    color: white;
    border-radius: 12px;
    font-size: 11px;
    margin-left: 8px;
}

/* ë„ë©´ ì¹´ë“œ */
.drawing-card {
    padding: 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.drawing-card:hover {
    background: #f9f9f9;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.drawing-tags {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.drawing-tag {
    padding: 2px 6px;
    background: #e0e7ff;
    color: #4338ca;
    border-radius: 12px;
    font-size: 11px;
}

/* ì„¤ì • ìŠ¤íƒ€ì¼ */
.settings-kv {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.settings-kv:last-child {
    border-bottom: none;
}

/* ì²´í¬ë°•ìŠ¤ */
.checkbox-label {
    display: flex;
    align-items: center;
    margin: 8px 0;
    cursor: pointer;
}

.checkbox-label input {
    margin-right: 8px;
}

/* ì£¼ê°„ ë·° */
.week-grid {
    display: grid;
    grid-template-columns: 60px repeat(7, 1fr);
    border: 1px solid var(--color-border);
}

.week-time-header {
    grid-column: 1;
    padding: 8px 4px;
    background: #f9f9f9;
    text-align: center;
    font-size: 11px;
    border-right: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
}

.week-day-header {
    padding: 8px;
    background: #f9f9f9;
    text-align: center;
    font-weight: 600;
    font-size: 12px;
    border-right: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
}

.week-time-slot {
    min-height: 40px;
    padding: 2px 4px;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    font-size: 11px;
    color: #999;
}

.week-slot {
    min-height: 40px;
    padding: 2px;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .left-panel {
        width: 100%;
    }

    .content-container {
        flex-direction: column;
    }
}
</style>
</head>
<body>
<div class="container">
    <!-- íƒ­ ë°” -->
    <div class="tab-container" id="tabs"></div>

    <!-- ì½˜í…ì¸  ì˜ì—­ -->
    <div class="content-container">
        <div class="left-panel" id="leftPanel"></div>
        <div class="right-panel" id="rightPanel"></div>
    </div>
</div>

<script>
// ì „ì—­ ìƒíƒœ
let state = {
    tabs: [],
    activeTabId: null,
    nextTabId: 1,
    settings: {
        defaults: { brand: 'SANGDO', form: 'ECONOMIC', location: 'INDOOR', mount: 'FLUSH' },
        rules: { singleBrand: true, antiPoleMistake: true, antiDeviceConfuse: true, antiInstallMismatch: true },
        knowledgeVersion: { rules: 'v1.0', tables: 'v1.0', updated: '2024-09-20' },
        history: []
    }
};

// ì´ˆê¸°í™”
function init() {
    loadState();
    if (state.tabs.length === 0) {
        addQuoteTab();
    }
    renderTabs();
    renderActiveTab();
}

// ìƒíƒœ ì €ì¥/ë¡œë“œ
function saveState() {
    localStorage.setItem('kis-erp-state', JSON.stringify(state));
}

function loadState() {
    const saved = localStorage.getItem('kis-erp-state');
    if (saved) {
        state = JSON.parse(saved);
    }
}

// íƒ­ ì‹œìŠ¤í…œ
function renderTabs() {
    const container = document.getElementById('tabs');
    container.innerHTML = '';

    state.tabs.forEach(tab => {
        const tabEl = document.createElement('div');
        tabEl.className = `tab ${tab.id === state.activeTabId ? 'active' : ''}`;
        tabEl.innerHTML = `
            <span onclick="switchTab(${tab.id})">${getTabIcon(tab.type)} ${tab.title}</span>
            ${state.tabs.length > 1 ? `<span class="tab-close" onclick="closeTab(${tab.id})">Ã—</span>` : ''}
        `;
        container.appendChild(tabEl);
    });

    // ìƒˆ íƒ­ ë“œë¡­ë‹¤ìš´
    const dropdown = document.createElement('div');
    dropdown.className = 'new-tab-dropdown';
    dropdown.innerHTML = `
        <button class="new-tab" onclick="toggleNewTabMenu()">+ ìƒˆ íƒ­</button>
        <div class="new-tab-menu" id="newTabMenu">
            <div class="new-tab-menu-item" onclick="addQuoteTab()">ğŸ“‹ ê²¬ì ì„œ</div>
            <div class="new-tab-menu-item" onclick="addCalendarTab()">ğŸ“… ìº˜ë¦°ë”</div>
            <div class="new-tab-menu-item" onclick="addEmailTab()">âœ‰ï¸ ì´ë©”ì¼</div>
            <div class="new-tab-menu-item" onclick="addDrawingsTab()">ğŸ“ ë„ë©´</div>
            <div class="new-tab-menu-item" onclick="addSettingsTab()">âš™ï¸ ì„¤ì •</div>
        </div>
    `;
    container.appendChild(dropdown);
}

function toggleNewTabMenu() {
    const menu = document.getElementById('newTabMenu');
    menu.classList.toggle('show');
}

function getTabIcon(type) {
    const icons = {
        quote: 'ğŸ“‹',
        calendar: 'ğŸ“…',
        email: 'âœ‰ï¸',
        drawings: 'ğŸ“',
        settings: 'âš™ï¸'
    };
    return icons[type] || 'ğŸ“„';
}

function switchTab(tabId) {
    state.activeTabId = tabId;
    saveState();
    renderTabs();
    renderActiveTab();
}

function closeTab(tabId) {
    if (state.tabs.length === 1) return;

    state.tabs = state.tabs.filter(t => t.id !== tabId);

    if (tabId === state.activeTabId) {
        state.activeTabId = state.tabs[0].id;
    }

    saveState();
    renderTabs();
    renderActiveTab();
}

function renderActiveTab() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (!tab) return;

    switch(tab.type) {
        case 'quote':
            renderQuoteTab(tab);
            break;
        case 'calendar':
            renderCalendarTab(tab);
            break;
        case 'email':
            renderEmailTab(tab);
            break;
        case 'drawings':
            renderDrawingsTab(tab);
            break;
        case 'settings':
            renderSettingsTab(tab);
            break;
    }
}

// ê²¬ì ì„œ íƒ­
function addQuoteTab() {
    const id = state.nextTabId++;
    const tab = {
        id,
        type: 'quote',
        title: `ê²¬ì ì„œ ${id}`,
        data: {
            customerInfo: { company: '', contact: '', email: '', address: '' },
            enclosureInfo: { type: 'ì˜¥ë‚´', boxType: '', material: '', request: '' },
            mainBreakerInfo: { type: 'MCCB', poles: '', capacity: '', brand: '' },
            branchBreakers: [],
            accessories: [],
            estimateVisible: false
        }
    };

    state.tabs.push(tab);
    state.activeTabId = id;
    saveState();
    renderTabs();
    renderActiveTab();
}

function renderQuoteTab(tab) {
    renderQuoteLeft(tab);
    renderQuoteRight(tab);
}

function renderQuoteLeft(tab) {
    const leftPanel = document.getElementById('leftPanel');
    const data = tab.data;

    leftPanel.innerHTML = `
        <!-- ê³ ê°ì •ë³´ -->
        <div class="section">
            <div class="section-header">ê³ ê°ì •ë³´</div>
            <div class="section-content">
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">ì—…ì²´ëª…</label>
                        <input type="text" class="form-input" id="company" value="${data.customerInfo.company}" placeholder="ì—…ì²´ëª… ì…ë ¥">
                    </div>
                    <div>
                        <label class="form-label">ì—°ë½ì²˜</label>
                        <input type="text" class="form-input" id="contact" value="${data.customerInfo.contact}" placeholder="ì—°ë½ì²˜ ì…ë ¥">
                    </div>
                </div>
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">ì´ë©”ì¼</label>
                        <input type="email" class="form-input" id="email" value="${data.customerInfo.email}" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    </div>
                    <div>
                        <label class="form-label">ì£¼ì†Œ</label>
                        <input type="text" class="form-input" id="address" value="${data.customerInfo.address}" placeholder="ì£¼ì†Œ ì…ë ¥">
                    </div>
                </div>
            </div>
        </div>

        <!-- ì™¸í•¨ì •ë³´ -->
        <div class="section">
            <div class="section-header">
                <span>ì™¸í•¨ì •ë³´</span>
                <div class="header-toggle">
                    <button class="header-toggle-option ${data.enclosureInfo.type === 'ì˜¥ë‚´' ? 'active' : ''}" onclick="toggleEnclosureType('ì˜¥ë‚´')">ì˜¥ë‚´</button>
                    <button class="header-toggle-option ${data.enclosureInfo.type === 'ì˜¥ì™¸' ? 'active' : ''}" onclick="toggleEnclosureType('ì˜¥ì™¸')">ì˜¥ì™¸</button>
                </div>
            </div>
            <div class="section-content">
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">í•¨ì²´íƒ€ì…</label>
                        <select class="form-select" id="boxType">
                            <option value="">ì„ íƒ</option>
                            <option value="ê¸°ì„±í•¨" ${data.enclosureInfo.boxType === 'ê¸°ì„±í•¨' ? 'selected' : ''}>ê¸°ì„±í•¨</option>
                            <option value="ì œì‘í•¨" ${data.enclosureInfo.boxType === 'ì œì‘í•¨' ? 'selected' : ''}>ì œì‘í•¨</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">ì¬ì§ˆ</label>
                        <select class="form-select" id="material">
                            <option value="">ì„ íƒ</option>
                            <option value="STEEL 1.6T" ${data.enclosureInfo.material === 'STEEL 1.6T' ? 'selected' : ''}>STEEL 1.6T</option>
                            <option value="STEEL 2.0T" ${data.enclosureInfo.material === 'STEEL 2.0T' ? 'selected' : ''}>STEEL 2.0T</option>
                            <option value="STS 1.5T" ${data.enclosureInfo.material === 'STS 1.5T' ? 'selected' : ''}>STS 1.5T</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì°¨ë‹¨ê¸° -->
        <div class="section">
            <div class="section-header">ë©”ì¸ ì°¨ë‹¨ê¸°</div>
            <div class="section-content">
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">ê·¹ìˆ˜</label>
                        <select class="form-select" id="mainPoles">
                            <option value="">ì„ íƒ</option>
                            <option value="2P">2P</option>
                            <option value="3P">3P</option>
                            <option value="4P">4P</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">ìš©ëŸ‰</label>
                        <select class="form-select" id="mainCapacity">
                            <option value="">ì„ íƒ</option>
                            <option value="100A">100A</option>
                            <option value="125A">125A</option>
                            <option value="150A">150A</option>
                            <option value="175A">175A</option>
                            <option value="200A">200A</option>
                            <option value="225A">225A</option>
                            <option value="250A">250A</option>
                            <option value="300A">300A</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; padding: 20px;">
            <button class="btn btn-primary" onclick="generateEstimate()">ê²¬ì  ìƒì„±</button>
        </div>
    `;

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    leftPanel.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', () => updateQuoteData(tab));
    });
}

function renderQuoteRight(tab) {
    const rightPanel = document.getElementById('rightPanel');
    const data = tab.data;

    if (!data.estimateVisible) {
        rightPanel.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <p>ì¢Œì¸¡ì—ì„œ ì •ë³´ë¥¼ ì…ë ¥í•œ í›„<br>ê²¬ì  ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
            </div>
        `;
    } else {
        // ê²¬ì  ê²°ê³¼ í‘œì‹œ
        let total = 1300000; // ê¸°ë³¸ê°’
        rightPanel.innerHTML = `
            <h3>ê²¬ì ì„œ</h3>
            <table>
                <thead>
                    <tr>
                        <th>í•­ëª©</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ë‹¨ê°€</th>
                        <th>ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ì™¸í•¨ (${data.enclosureInfo.boxType || 'ê¸°ì„±í•¨'} - ${data.enclosureInfo.material || 'STEEL 1.6T'})</td>
                        <td>1</td>
                        <td>850,000</td>
                        <td>850,000</td>
                    </tr>
                    <tr>
                        <td>ë©”ì¸ì°¨ë‹¨ê¸° (${data.mainBreakerInfo.type} ${data.mainBreakerInfo.poles || '4P'} ${data.mainBreakerInfo.capacity || '200A'})</td>
                        <td>1</td>
                        <td>450,000</td>
                        <td>450,000</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3">í•©ê³„</th>
                        <th>${total.toLocaleString()}ì›</th>
                    </tr>
                </tfoot>
            </table>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="sendEstimateEmail()">ì´ë©”ì¼ ì „ì†¡</button>
                <button class="btn" onclick="addEstimateToCalendar()">ìº˜ë¦°ë”ì— ì¶”ê°€</button>
            </div>
        `;
    }
}

function updateQuoteData(tab) {
    const data = tab.data;
    data.customerInfo.company = document.getElementById('company')?.value || '';
    data.customerInfo.contact = document.getElementById('contact')?.value || '';
    data.customerInfo.email = document.getElementById('email')?.value || '';
    data.customerInfo.address = document.getElementById('address')?.value || '';
    data.enclosureInfo.boxType = document.getElementById('boxType')?.value || '';
    data.enclosureInfo.material = document.getElementById('material')?.value || '';
    data.mainBreakerInfo.poles = document.getElementById('mainPoles')?.value || '';
    data.mainBreakerInfo.capacity = document.getElementById('mainCapacity')?.value || '';
    saveState();
}

function toggleEnclosureType(type) {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'quote') {
        tab.data.enclosureInfo.type = type;
        saveState();
        renderQuoteLeft(tab);
    }
}

function generateEstimate() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'quote') {
        tab.data.estimateVisible = true;
        saveState();
        renderQuoteRight(tab);
        showBanner('success', 'ê²¬ì ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
}

// ìº˜ë¦°ë” íƒ­
function addCalendarTab() {
    const id = state.nextTabId++;
    const tab = {
        id,
        type: 'calendar',
        title: `ìº˜ë¦°ë” ${id}`,
        data: {
            view: 'month',
            range: {
                start: new Date().toISOString().split('T')[0],
                end: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0]
            },
            filters: {
                types: { estimate: true, install: true, inbound: true, misc: true },
                owner: '',
                q: ''
            },
            events: [
                { id: 'cal_1', type: 'estimate', title: 'ì‚¼ì„±ì „ì ê²¬ì ', start: new Date().toISOString(), end: new Date(Date.now() + 2*60*60*1000).toISOString(), location: 'ì„œìš¸', memo: '', owner: 'ê¹€ê³¼ì¥' },
                { id: 'cal_2', type: 'install', title: 'LGì „ì ì„¤ì¹˜', start: new Date(Date.now() + 3*24*60*60*1000).toISOString(), end: new Date(Date.now() + 3*24*60*60*1000 + 4*60*60*1000).toISOString(), location: 'ìˆ˜ì›', memo: '', owner: 'ì´ëŒ€ë¦¬' }
            ],
            selectedDate: new Date().toISOString().split('T')[0]
        }
    };

    state.tabs.push(tab);
    state.activeTabId = id;
    saveState();
    renderTabs();
    renderActiveTab();
}

function renderCalendarTab(tab) {
    renderCalendarLeft(tab);
    renderCalendarRight(tab);
}

function renderCalendarLeft(tab) {
    const leftPanel = document.getElementById('leftPanel');
    const data = tab.data;

    leftPanel.innerHTML = `
        <!-- ê¸°ê°„/ë³´ê¸° ëª¨ë“œ -->
        <div class="section">
            <div class="section-header">
                <span>ë³´ê¸° ëª¨ë“œ</span>
                <div class="header-toggle">
                    <button class="header-toggle-option ${data.view === 'month' ? 'active' : ''}" onclick="setCalendarView('month')">ì›”ê°„</button>
                    <button class="header-toggle-option ${data.view === 'week' ? 'active' : ''}" onclick="setCalendarView('week')">ì£¼ê°„</button>
                </div>
            </div>
            <div class="section-content">
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">ì‹œì‘ì¼</label>
                        <input type="date" class="form-input" id="calStart" value="${data.range.start}">
                    </div>
                    <div>
                        <label class="form-label">ì¢…ë£Œì¼</label>
                        <input type="date" class="form-input" id="calEnd" value="${data.range.end}">
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¼ì • í•„í„° -->
        <div class="section">
            <div class="section-header">ì¼ì • í•„í„°</div>
            <div class="section-content">
                <label class="checkbox-label">
                    <input type="checkbox" ${data.filters.types.estimate ? 'checked' : ''} onchange="toggleEventType('estimate')">
                    ê²¬ì 
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" ${data.filters.types.install ? 'checked' : ''} onchange="toggleEventType('install')">
                    ì„¤ì¹˜
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" ${data.filters.types.inbound ? 'checked' : ''} onchange="toggleEventType('inbound')">
                    ì…ê³ 
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" ${data.filters.types.misc ? 'checked' : ''} onchange="toggleEventType('misc')">
                    ê¸°íƒ€
                </label>
                <div class="form-row">
                    <label class="form-label">ë‹´ë‹¹ì</label>
                    <input type="text" class="form-input" id="calOwner" placeholder="ë‹´ë‹¹ì ê²€ìƒ‰" value="${data.filters.owner}">
                </div>
            </div>
        </div>

        <!-- ìƒˆ ì¼ì • ì¶”ê°€ -->
        <div class="section">
            <div class="section-header">ìƒˆ ì¼ì • ì¶”ê°€</div>
            <div class="section-content">
                <div class="form-row">
                    <label class="form-label">ì œëª©</label>
                    <input type="text" class="form-input" id="eventTitle" placeholder="ì¼ì • ì œëª©">
                </div>
                <div class="form-row">
                    <label class="form-label">íƒ€ì…</label>
                    <select class="form-select" id="eventType">
                        <option value="estimate">ê²¬ì </option>
                        <option value="install">ì„¤ì¹˜</option>
                        <option value="inbound">ì…ê³ </option>
                        <option value="misc">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">ì‹œì‘</label>
                        <input type="datetime-local" class="form-input" id="eventStart">
                    </div>
                    <div>
                        <label class="form-label">ì¢…ë£Œ</label>
                        <input type="datetime-local" class="form-input" id="eventEnd">
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label">ì¥ì†Œ</label>
                    <input type="text" class="form-input" id="eventLocation" placeholder="ì¥ì†Œ">
                </div>
                <div class="form-row">
                    <label class="form-label">ë©”ëª¨</label>
                    <textarea class="form-textarea" id="eventMemo" placeholder="ë©”ëª¨"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addCalendarEvent()">ì¼ì • ì¶”ê°€</button>
            </div>
        </div>
    `;
}

function renderCalendarRight(tab) {
    const rightPanel = document.getElementById('rightPanel');
    const data = tab.data;

    if (data.view === 'month') {
        renderMonthView(rightPanel, data);
    } else {
        renderWeekView(rightPanel, data);
    }
}

function renderMonthView(container, data) {
    const today = new Date();
    const currentMonth = new Date(data.selectedDate);
    const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);

    let html = `
        <div class="calendar-navigation">
            <button class="calendar-nav-btn" onclick="calendarNavigate('prev')">â—€</button>
            <span>${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth() + 1}ì›”</span>
            <button class="calendar-nav-btn" onclick="calendarNavigate('next')">â–¶</button>
        </div>
        <div class="calendar-grid">
    `;

    // ìš”ì¼ í—¤ë”
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    days.forEach(day => {
        html += `<div class="calendar-header-cell">${day}</div>`;
    });

    // ë‚ ì§œ ì…€
    const startPadding = firstDay.getDay();
    for (let i = 0; i < startPadding; i++) {
        html += `<div class="calendar-cell other-month"></div>`;
    }

    for (let date = 1; date <= lastDay.getDate(); date++) {
        const cellDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), date);
        const isToday = cellDate.toDateString() === today.toDateString();
        const events = getEventsForDate(data.events, cellDate, data.filters);

        html += `
            <div class="calendar-cell ${isToday ? 'today' : ''}">
                <div class="calendar-day">${date}</div>
                ${events.map(e => `
                    <div class="calendar-event ${e.type}" title="${e.title} - ${e.location || ''}">
                        ${e.title}
                    </div>
                `).join('')}
            </div>
        `;
    }

    html += `</div>`;
    container.innerHTML = html;
}

function renderWeekView(container, data) {
    const currentDate = new Date(data.selectedDate);
    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());

    let html = `
        <div class="calendar-navigation">
            <button class="calendar-nav-btn" onclick="calendarNavigate('prev')">â—€</button>
            <span>${weekStart.toLocaleDateString()} - ${new Date(weekStart.getTime() + 6*24*60*60*1000).toLocaleDateString()}</span>
            <button class="calendar-nav-btn" onclick="calendarNavigate('next')">â–¶</button>
        </div>
        <div class="week-grid">
            <div class="week-time-header"></div>
    `;

    // ìš”ì¼ í—¤ë”
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart.getTime() + i*24*60*60*1000);
        html += `<div class="week-day-header">${days[i]}<br>${date.getMonth()+1}/${date.getDate()}</div>`;
    }

    // ì‹œê°„ ìŠ¬ë¡¯
    for (let hour = 0; hour < 24; hour++) {
        html += `<div class="week-time-slot">${hour}:00</div>`;
        for (let day = 0; day < 7; day++) {
            html += `<div class="week-slot"></div>`;
        }
    }

    html += `</div>`;
    container.innerHTML = html;
}

function getEventsForDate(events, date, filters) {
    return events.filter(e => {
        const eventDate = new Date(e.start);
        return eventDate.toDateString() === date.toDateString() && filters.types[e.type];
    });
}

function setCalendarView(view) {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'calendar') {
        tab.data.view = view;
        saveState();
        renderCalendarTab(tab);
    }
}

function toggleEventType(type) {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'calendar') {
        tab.data.filters.types[type] = !tab.data.filters.types[type];
        saveState();
        renderCalendarRight(tab);
    }
}

function calendarNavigate(direction) {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'calendar') {
        const current = new Date(tab.data.selectedDate);
        if (tab.data.view === 'month') {
            if (direction === 'prev') {
                current.setMonth(current.getMonth() - 1);
            } else {
                current.setMonth(current.getMonth() + 1);
            }
        } else {
            if (direction === 'prev') {
                current.setDate(current.getDate() - 7);
            } else {
                current.setDate(current.getDate() + 7);
            }
        }
        tab.data.selectedDate = current.toISOString().split('T')[0];
        saveState();
        renderCalendarRight(tab);
    }
}

function addCalendarEvent() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'calendar') {
        const title = document.getElementById('eventTitle').value;
        const type = document.getElementById('eventType').value;
        const start = document.getElementById('eventStart').value;
        const end = document.getElementById('eventEnd').value;
        const location = document.getElementById('eventLocation').value;
        const memo = document.getElementById('eventMemo').value;

        if (!title || !start) {
            showBanner('error', 'ì œëª©ê³¼ ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        const event = {
            id: `cal_${Date.now()}`,
            type,
            title,
            start: new Date(start).toISOString(),
            end: end ? new Date(end).toISOString() : new Date(start).toISOString(),
            location,
            memo,
            owner: 'í˜„ì¬ ì‚¬ìš©ì'
        };

        tab.data.events.push(event);
        saveState();
        renderCalendarTab(tab);
        showBanner('success', 'ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
}

// ì´ë©”ì¼ íƒ­
function addEmailTab() {
    const id = state.nextTabId++;
    const tab = {
        id,
        type: 'email',
        title: `ì´ë©”ì¼ ${id}`,
        data: {
            compose: { to: '', cc: '', subject: '', body: '', attachQuote: false },
            threads: [
                { id: 'em_1', to: 'samsung@example.com', subject: '[ê²¬ì ì„œ] ì‚¼ì„±ì „ì í”„ë¡œì íŠ¸', body: 'ê²¬ì ì„œ ì†¡ë¶€ë“œë¦½ë‹ˆë‹¤.', status: 'SENT', ts: new Date().toISOString(), attachments: [], groupId: 'grp_1' },
                { id: 'em_2', to: 'lg@example.com', subject: 'ë¬¸ì˜ì‚¬í•­ ë‹µë³€', body: 'ë¬¸ì˜í•˜ì‹  ë‚´ìš© ë‹µë³€ë“œë¦½ë‹ˆë‹¤.', status: 'DRAFT', ts: new Date().toISOString(), attachments: [], groupId: null }
            ],
            groups: [
                { id: 'grp_1', name: 'ì£¼ìš”ê±°ë˜ì²˜', rules: ['@samsung.com', '@lg.com'], color: '#3b82f6' },
                { id: 'grp_2', name: 'í˜‘ë ¥ì—…ì²´', rules: ['@partner.com'], color: '#10b981' }
            ],
            filters: { start: '', end: '', partner: '', status: '', groupId: '' },
            selectedThreadId: null
        }
    };

    state.tabs.push(tab);
    state.activeTabId = id;
    saveState();
    renderTabs();
    renderActiveTab();
}

function renderEmailTab(tab) {
    renderEmailLeft(tab);
    renderEmailRight(tab);
}

function renderEmailLeft(tab) {
    const leftPanel = document.getElementById('leftPanel');
    const data = tab.data;

    leftPanel.innerHTML = `
        <!-- ë©”ì¼ ì‘ì„± -->
        <div class="section">
            <div class="section-header">ë©”ì¼ ì‘ì„±</div>
            <div class="section-content">
                <div class="form-row">
                    <label class="form-label">ë°›ëŠ”ì‚¬ëŒ (To)</label>
                    <input type="email" class="form-input" id="emailTo" placeholder="email@example.com" value="${data.compose.to}">
                </div>
                <div class="form-row">
                    <label class="form-label">ì°¸ì¡° (Cc)</label>
                    <input type="email" class="form-input" id="emailCc" placeholder="cc@example.com" value="${data.compose.cc}">
                </div>
                <div class="form-row">
                    <label class="form-label">ì œëª©</label>
                    <input type="text" class="form-input" id="emailSubject" placeholder="ë©”ì¼ ì œëª©" value="${data.compose.subject}">
                </div>
                <div class="form-row">
                    <label class="form-label">ë³¸ë¬¸</label>
                    <textarea class="form-textarea" id="emailBody" rows="5" placeholder="ë©”ì¼ ë‚´ìš©">${data.compose.body}</textarea>
                </div>
                <label class="checkbox-label">
                    <input type="checkbox" id="attachQuote" ${data.compose.attachQuote ? 'checked' : ''}>
                    ê²¬ì ì„œ(PDF) ì²¨ë¶€
                </label>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="btn" onclick="saveDraft()">ì„ì‹œì €ì¥</button>
                    <button class="btn btn-primary" onclick="sendEmail()">ë³´ë‚´ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ê·¸ë£¹ ê´€ë¦¬ -->
        <div class="section">
            <div class="section-header">ê·¸ë£¹ ê´€ë¦¬</div>
            <div class="section-content">
                <div class="form-row cols-2">
                    <input type="text" class="form-input" id="newGroupName" placeholder="ê·¸ë£¹ëª…">
                    <button class="btn btn-primary" onclick="addEmailGroup()">ì¶”ê°€</button>
                </div>
                <div class="item-list" style="margin-top: 12px;">
                    ${data.groups.map(g => `
                        <div class="list-item">
                            <span style="display: flex; align-items: center;">
                                <span style="width: 12px; height: 12px; background: ${g.color}; border-radius: 50%; margin-right: 8px;"></span>
                                ${g.name}
                            </span>
                            <button class="btn btn-small" onclick="deleteEmailGroup('${g.id}')">ì‚­ì œ</button>
                        </div>
                    `).join('') || '<div class="list-empty">ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                </div>
                <div class="form-row" style="margin-top: 12px;">
                    <label class="form-label">ìë™ ë¶„ë¥˜ ê·œì¹™ (ë„ë©”ì¸ ë˜ëŠ” ì´ë©”ì¼)</label>
                    <input type="text" class="form-input" id="groupRule" placeholder="@domain.com ë˜ëŠ” user@email.com">
                    <button class="btn btn-small" onclick="addGroupRule()" style="margin-top: 4px;">ê·œì¹™ ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <!-- ê²€ìƒ‰/í•„í„° -->
        <div class="section">
            <div class="section-header">ê²€ìƒ‰/í•„í„°</div>
            <div class="section-content">
                <div class="form-row">
                    <label class="form-label">ê·¸ë£¹</label>
                    <select class="form-select" id="filterGroup" onchange="filterEmails()">
                        <option value="">ì „ì²´</option>
                        ${data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-row">
                    <label class="form-label">ìƒíƒœ</label>
                    <select class="form-select" id="filterStatus" onchange="filterEmails()">
                        <option value="">ì „ì²´</option>
                        <option value="SENT">ë³´ëƒ„</option>
                        <option value="DRAFT">ì„ì‹œì €ì¥</option>
                        <option value="FAILED">ì‹¤íŒ¨</option>
                    </select>
                </div>
                <div class="form-row">
                    <label class="form-label">ê²€ìƒ‰ì–´</label>
                    <input type="text" class="form-input" id="filterKeyword" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰" onkeyup="filterEmails()">
                </div>
            </div>
        </div>
    `;
}

function renderEmailRight(tab) {
    const rightPanel = document.getElementById('rightPanel');
    const data = tab.data;

    if (data.selectedThreadId) {
        const thread = data.threads.find(t => t.id === data.selectedThreadId);
        if (thread) {
            const group = data.groups.find(g => g.id === thread.groupId);
            rightPanel.innerHTML = `
                <div style="padding: 20px; border: 1px solid var(--color-border); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>${thread.subject}</h3>
                        <span class="email-status ${thread.status.toLowerCase()}">${thread.status}</span>
                    </div>
                    ${group ? `<span class="email-group-badge" style="background: ${group.color}">${group.name}</span>` : ''}
                    <div class="settings-kv">
                        <span>ë°›ëŠ”ì‚¬ëŒ:</span>
                        <span>${thread.to}</span>
                    </div>
                    <div class="settings-kv">
                        <span>ë³´ë‚¸ì‹œê°„:</span>
                        <span>${new Date(thread.ts).toLocaleString()}</span>
                    </div>
                    <div style="padding: 16px 0; border-top: 1px solid var(--color-border); margin-top: 16px;">
                        ${thread.body}
                    </div>
                    ${thread.attachments.length > 0 ? `
                        <div style="padding: 12px; background: #f9f9f9; border-radius: 4px; margin-top: 16px;">
                            <strong>ì²¨ë¶€íŒŒì¼:</strong>
                            ${thread.attachments.map(a => `<div>ğŸ“ ${a.name}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
    } else {
        // ë©”ì¼ ë¦¬ìŠ¤íŠ¸
        const filteredThreads = filterEmailThreads(data.threads, data.filters);
        rightPanel.innerHTML = `
            <h3>ë©”ì¼í•¨ (${filteredThreads.length})</h3>
            <div style="margin-top: 16px;">
                ${filteredThreads.map(thread => {
                    const group = data.groups.find(g => g.id === thread.groupId);
                    return `
                        <div class="email-thread ${data.selectedThreadId === thread.id ? 'selected' : ''}" onclick="selectEmailThread('${thread.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${thread.subject}</strong>
                                <span class="email-status ${thread.status.toLowerCase()}">${thread.status}</span>
                            </div>
                            <div style="font-size: 13px; color: var(--color-text-subtle); margin-top: 4px;">
                                ${thread.to} Â· ${new Date(thread.ts).toLocaleDateString()}
                                ${group ? `<span class="email-group-badge" style="background: ${group.color}">${group.name}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'}
            </div>
        `;
    }
}

function filterEmailThreads(threads, filters) {
    return threads.filter(thread => {
        if (filters.groupId && thread.groupId !== filters.groupId) return false;
        if (filters.status && thread.status !== filters.status) return false;
        // ì¶”ê°€ í•„í„° ë¡œì§...
        return true;
    });
}

function selectEmailThread(threadId) {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'email') {
        tab.data.selectedThreadId = threadId;
        saveState();
        renderEmailRight(tab);
    }
}

function saveDraft() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'email') {
        const to = document.getElementById('emailTo').value;
        const subject = document.getElementById('emailSubject').value;
        const body = document.getElementById('emailBody').value;

        const draft = {
            id: `em_${Date.now()}`,
            to,
            cc: document.getElementById('emailCc').value,
            subject,
            body,
            status: 'DRAFT',
            ts: new Date().toISOString(),
            attachments: [],
            groupId: assignEmailGroup(to, tab.data.groups)
        };

        tab.data.threads.push(draft);
        saveState();
        renderEmailTab(tab);
        showBanner('success', 'ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
}

function sendEmail() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'email') {
        const to = document.getElementById('emailTo').value;
        const subject = document.getElementById('emailSubject').value;

        if (!to || !subject) {
            showBanner('error', 'ë°›ëŠ”ì‚¬ëŒê³¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        const email = {
            id: `em_${Date.now()}`,
            to,
            cc: document.getElementById('emailCc').value,
            subject,
            body: document.getElementById('emailBody').value,
            status: 'SENT',
            ts: new Date().toISOString(),
            attachments: document.getElementById('attachQuote').checked ? [{type: 'pdf', name: 'ê²¬ì ì„œ.pdf'}] : [],
            groupId: assignEmailGroup(to, tab.data.groups)
        };

        tab.data.threads.push(email);

        // ì‘ì„± í¼ ì´ˆê¸°í™”
        document.getElementById('emailTo').value = '';
        document.getElementById('emailCc').value = '';
        document.getElementById('emailSubject').value = '';
        document.getElementById('emailBody').value = '';
        document.getElementById('attachQuote').checked = false;

        saveState();
        renderEmailTab(tab);
        showBanner('success', 'ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
}

function assignEmailGroup(email, groups) {
    for (const group of groups) {
        for (const rule of group.rules) {
            if (rule.startsWith('@')) {
                // ë„ë©”ì¸ ë§¤ì¹­
                if (email.endsWith(rule.substring(1))) {
                    return group.id;
                }
            } else {
                // ì •í™•í•œ ì´ë©”ì¼ ë§¤ì¹­
                if (email === rule) {
                    return group.id;
                }
            }
        }
    }
    return null;
}

function addEmailGroup() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'email') {
        const name = document.getElementById('newGroupName').value;
        if (!name) {
            showBanner('error', 'ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        const group = {
            id: `grp_${Date.now()}`,
            name,
            rules: [],
            color: '#' + Math.floor(Math.random()*16777215).toString(16)
        };

        tab.data.groups.push(group);
        document.getElementById('newGroupName').value = '';
        saveState();
        renderEmailLeft(tab);
        showBanner('success', 'ê·¸ë£¹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
}

function deleteEmailGroup(groupId) {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'email') {
        tab.data.groups = tab.data.groups.filter(g => g.id !== groupId);
        // í•´ë‹¹ ê·¸ë£¹ì˜ ë©”ì¼ë“¤ ê·¸ë£¹ í•´ì œ
        tab.data.threads.forEach(t => {
            if (t.groupId === groupId) t.groupId = null;
        });
        saveState();
        renderEmailTab(tab);
    }
}

function filterEmails() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'email') {
        tab.data.filters.groupId = document.getElementById('filterGroup').value;
        tab.data.filters.status = document.getElementById('filterStatus').value;
        saveState();
        renderEmailRight(tab);
    }
}

// ë„ë©´ íƒ­
function addDrawingsTab() {
    const id = state.nextTabId++;
    const tab = {
        id,
        type: 'drawings',
        title: `ë„ë©´ ${id}`,
        data: {
            documents: [
                { id: 'dwg_1', name: 'PANEL-A.dwg', rev: 'A', date: '2024-09-15', author: 'ê¹€ì„¤ê³„', tags: ['MCCB', 'ì˜¥ë‚´'], memo: 'ì´ˆë„ ì„¤ê³„', history: [], links: [] },
                { id: 'dwg_2', name: 'LAYOUT-B.pdf', rev: 'B', date: '2024-09-18', author: 'ì´ì„¤ê³„', tags: ['ë°°ì¹˜ë„'], memo: 'ìˆ˜ì •ë³¸', history: [], links: [] }
            ],
            filters: { q: '', rev: '', start: '', end: '', tag: '' },
            selectedId: null
        }
    };

    state.tabs.push(tab);
    state.activeTabId = id;
    saveState();
    renderTabs();
    renderActiveTab();
}

function renderDrawingsTab(tab) {
    renderDrawingsLeft(tab);
    renderDrawingsRight(tab);
}

function renderDrawingsLeft(tab) {
    const leftPanel = document.getElementById('leftPanel');
    const data = tab.data;

    leftPanel.innerHTML = `
        <!-- ë„ë©´ ë“±ë¡ -->
        <div class="section">
            <div class="section-header">ë„ë©´ ë“±ë¡</div>
            <div class="section-content">
                <div class="form-row">
                    <label class="form-label">íŒŒì¼ëª…</label>
                    <input type="text" class="form-input" id="dwgName" placeholder="ì˜ˆ: PANEL-A.dwg">
                </div>
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">íŒë²ˆí˜¸ (Rev)</label>
                        <input type="text" class="form-input" id="dwgRev" placeholder="A">
                    </div>
                    <div>
                        <label class="form-label">ì‘ì„±ì¼</label>
                        <input type="date" class="form-input" id="dwgDate">
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label">ì‘ì„±ì</label>
                    <input type="text" class="form-input" id="dwgAuthor" placeholder="ì‘ì„±ìëª…">
                </div>
                <div class="form-row">
                    <label class="form-label">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" class="form-input" id="dwgTags" placeholder="MCCB, ì˜¥ë‚´, ë°°ì¹˜ë„">
                </div>
                <div class="form-row">
                    <label class="form-label">ë©”ëª¨</label>
                    <textarea class="form-textarea" id="dwgMemo" placeholder="ì„¤ëª… ë˜ëŠ” ë©”ëª¨"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addDrawing()">ë„ë©´ ë“±ë¡</button>
            </div>
        </div>

        <!-- ê²€ìƒ‰/í•„í„° -->
        <div class="section">
            <div class="section-header">ê²€ìƒ‰/í•„í„°</div>
            <div class="section-content">
                <div class="form-row">
                    <label class="form-label">íŒŒì¼ëª… ê²€ìƒ‰</label>
                    <input type="text" class="form-input" id="dwgSearch" placeholder="íŒŒì¼ëª… ê²€ìƒ‰" onkeyup="filterDrawings()">
                </div>
                <div class="form-row">
                    <label class="form-label">íƒœê·¸</label>
                    <input type="text" class="form-input" id="dwgTagFilter" placeholder="íƒœê·¸ ê²€ìƒ‰" onkeyup="filterDrawings()">
                </div>
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">ì‹œì‘ì¼</label>
                        <input type="date" class="form-input" id="dwgStartDate" onchange="filterDrawings()">
                    </div>
                    <div>
                        <label class="form-label">ì¢…ë£Œì¼</label>
                        <input type="date" class="form-input" id="dwgEndDate" onchange="filterDrawings()">
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderDrawingsRight(tab) {
    const rightPanel = document.getElementById('rightPanel');
    const data = tab.data;

    if (data.selectedId) {
        const doc = data.documents.find(d => d.id === data.selectedId);
        if (doc) {
            rightPanel.innerHTML = `
                <div style="padding: 20px; border: 1px solid var(--color-border); border-radius: 4px;">
                    <h3>${doc.name}</h3>
                    <div class="settings-kv">
                        <span>íŒë²ˆí˜¸:</span>
                        <span>Rev ${doc.rev}</span>
                    </div>
                    <div class="settings-kv">
                        <span>ì‘ì„±ì¼:</span>
                        <span>${doc.date}</span>
                    </div>
                    <div class="settings-kv">
                        <span>ì‘ì„±ì:</span>
                        <span>${doc.author}</span>
                    </div>
                    <div class="drawing-tags">
                        ${doc.tags.map(tag => `<span class="drawing-tag">${tag}</span>`).join('')}
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: #f9f9f9; border-radius: 4px;">
                        <strong>ë©”ëª¨:</strong><br>${doc.memo}
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn" onclick="linkToEstimate('${doc.id}')">ê²¬ì  ì—°ê²°</button>
                        <button class="btn" onclick="addDrawingNote('${doc.id}')">ë©”ëª¨ ì¶”ê°€</button>
                    </div>
                </div>
            `;
        }
    } else {
        // ë„ë©´ ë¦¬ìŠ¤íŠ¸
        rightPanel.innerHTML = `
            <h3>ë„ë©´ ëª©ë¡ (${data.documents.length})</h3>
            <div style="margin-top: 16px;">
                ${data.documents.map(doc => `
                    <div class="drawing-card" onclick="selectDrawing('${doc.id}')">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${doc.name}</strong>
                            <span style="color: var(--color-text-subtle);">Rev ${doc.rev}</span>
                        </div>
                        <div style="font-size: 13px; color: var(--color-text-subtle); margin-top: 4px;">
                            ${doc.author} Â· ${doc.date}
                        </div>
                        <div class="drawing-tags">
                            ${doc.tags.map(tag => `<span class="drawing-tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                `).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>ë“±ë¡ëœ ë„ë©´ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'}
            </div>
        `;
    }
}

function addDrawing() {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'drawings') {
        const name = document.getElementById('dwgName').value;
        const rev = document.getElementById('dwgRev').value;

        if (!name || !rev) {
            showBanner('error', 'íŒŒì¼ëª…ê³¼ íŒë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        // ì¤‘ë³µ ì²´í¬
        const existing = tab.data.documents.find(d => d.name === name && d.rev === rev);
        if (existing) {
            if (!confirm('ê°™ì€ íŒŒì¼ëª…ê³¼ íŒë²ˆí˜¸ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            tab.data.documents = tab.data.documents.filter(d => !(d.name === name && d.rev === rev));
        }

        const doc = {
            id: `dwg_${Date.now()}`,
            name,
            rev,
            date: document.getElementById('dwgDate').value || new Date().toISOString().split('T')[0],
            author: document.getElementById('dwgAuthor').value || 'ë¯¸ì§€ì •',
            tags: document.getElementById('dwgTags').value.split(',').map(t => t.trim()).filter(t => t),
            memo: document.getElementById('dwgMemo').value,
            history: [{ ts: new Date().toISOString(), action: 'REGISTER', note: 'ì´ˆë„ ë“±ë¡' }],
            links: []
        };

        tab.data.documents.push(doc);

        // í¼ ì´ˆê¸°í™”
        document.getElementById('dwgName').value = '';
        document.getElementById('dwgRev').value = '';
        document.getElementById('dwgDate').value = '';
        document.getElementById('dwgAuthor').value = '';
        document.getElementById('dwgTags').value = '';
        document.getElementById('dwgMemo').value = '';

        saveState();
        renderDrawingsTab(tab);
        showBanner('success', 'ë„ë©´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
}

function selectDrawing(docId) {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'drawings') {
        tab.data.selectedId = docId;
        saveState();
        renderDrawingsRight(tab);
    }
}

function filterDrawings() {
    // í•„í„° ë¡œì§ êµ¬í˜„
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab && tab.type === 'drawings') {
        renderDrawingsRight(tab);
    }
}

// ì„¤ì • íƒ­
function addSettingsTab() {
    // ì„¤ì •ì€ ì‹±ê¸€í†¤
    const existing = state.tabs.find(t => t.type === 'settings');
    if (existing) {
        switchTab(existing.id);
        return;
    }

    const id = state.nextTabId++;
    const tab = {
        id,
        type: 'settings',
        title: 'ì„¤ì •',
        data: {} // ì„¤ì •ì€ ì „ì—­ state.settings ì‚¬ìš©
    };

    state.tabs.push(tab);
    state.activeTabId = id;
    saveState();
    renderTabs();
    renderActiveTab();
}

function renderSettingsTab(tab) {
    renderSettingsLeft();
    renderSettingsRight();
}

function renderSettingsLeft() {
    const leftPanel = document.getElementById('leftPanel');
    const s = state.settings;

    leftPanel.innerHTML = `
        <!-- ë¸Œëœë“œ/í˜•íƒœ ê¸°ë³¸ -->
        <div class="section">
            <div class="section-header">ë¸Œëœë“œ / í˜•íƒœ ê¸°ë³¸</div>
            <div class="section-content">
                <div class="form-row">
                    <label class="form-label">ë¸Œëœë“œ</label>
                    <select class="form-select" id="settingBrand" onchange="updateSetting('brand', this.value)">
                        <option value="SANGDO" ${s.defaults.brand === 'SANGDO' ? 'selected' : ''}>ìƒë„</option>
                        <option value="LS" ${s.defaults.brand === 'LS' ? 'selected' : ''}>LS</option>
                    </select>
                </div>
                <div class="form-row">
                    <label class="form-label">í˜•íƒœ</label>
                    <select class="form-select" id="settingForm" onchange="updateSetting('form', this.value)">
                        <option value="ECONOMIC" ${s.defaults.form === 'ECONOMIC' ? 'selected' : ''}>ê²½ì œí˜•</option>
                        <option value="STANDARD" ${s.defaults.form === 'STANDARD' ? 'selected' : ''}>í‘œì¤€í˜•</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ì„¤ì¹˜ ê¸°ë³¸ -->
        <div class="section">
            <div class="section-header">ì„¤ì¹˜ ê¸°ë³¸</div>
            <div class="section-content">
                <div class="form-row cols-2">
                    <div>
                        <label class="form-label">ì¥ì†Œ</label>
                        <select class="form-select" onchange="updateSetting('location', this.value)">
                            <option value="INDOOR" ${s.defaults.location === 'INDOOR' ? 'selected' : ''}>ì˜¥ë‚´</option>
                            <option value="OUTDOOR" ${s.defaults.location === 'OUTDOOR' ? 'selected' : ''}>ì˜¥ì™¸</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">ë°©ì‹</label>
                        <select class="form-select" onchange="updateSetting('mount', this.value)">
                            <option value="FLUSH" ${s.defaults.mount === 'FLUSH' ? 'selected' : ''}>ë§¤ì…</option>
                            <option value="SURFACE" ${s.defaults.mount === 'SURFACE' ? 'selected' : ''}>ë…¸ì¶œ</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë£° & ì¹˜ìˆ˜í‘œ ë²„ì „ -->
        <div class="section">
            <div class="section-header">ë£° & ì¹˜ìˆ˜í‘œ ë²„ì „</div>
            <div class="section-content">
                <div class="settings-kv">
                    <span>ëŒ€í‘œë‹˜ ì§€ì‹ ë²„ì „</span>
                    <span>rules ${s.knowledgeVersion.rules} / tables ${s.knowledgeVersion.tables}</span>
                </div>
                <div class="settings-kv">
                    <span>ìµœì¢… ì—…ë°ì´íŠ¸</span>
                    <span>${s.knowledgeVersion.updated}</span>
                </div>
                <label class="checkbox-label">
                    <input type="checkbox" ${s.rules.singleBrand ? 'checked' : ''} onchange="updateRule('singleBrand', this.checked)">
                    ë‹¨ì¼ ë¸Œëœë“œ ì›ì¹™
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" ${s.rules.antiPoleMistake ? 'checked' : ''} onchange="updateRule('antiPoleMistake', this.checked)">
                    ê·¹ìˆ˜ ì˜¤íŒ ë°©ì§€
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" ${s.rules.antiDeviceConfuse ? 'checked' : ''} onchange="updateRule('antiDeviceConfuse', this.checked)">
                    MCCB/ELCB í˜¼ë™ ë°©ì§€
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" ${s.rules.antiInstallMismatch ? 'checked' : ''} onchange="updateRule('antiInstallMismatch', this.checked)">
                    ì˜¥ë‚´/ì˜¥ì™¸ Â· ë§¤ì…/ë…¸ì¶œ ì˜¤ë¥˜ ë°©ì§€
                </label>
            </div>
        </div>

        <!-- ë°±ì—…/ë³µêµ¬ -->
        <div class="section">
            <div class="section-header">ë°±ì—… / ë³µêµ¬</div>
            <div class="section-content">
                <button class="btn" onclick="exportSettings()">JSON ë‚´ë³´ë‚´ê¸°</button>
                <textarea class="form-textarea" id="settingsJson" placeholder="JSON ë¶™ì—¬ë„£ê¸° í›„ ê°€ì ¸ì˜¤ê¸°" style="margin-top: 12px;"></textarea>
                <button class="btn btn-primary" onclick="importSettings()" style="margin-top: 8px;">ê°€ì ¸ì˜¤ê¸°</button>
            </div>
        </div>
    `;
}

function renderSettingsRight() {
    const rightPanel = document.getElementById('rightPanel');
    const s = state.settings;

    rightPanel.innerHTML = `
        <h3>ì„¤ì • ìš”ì•½</h3>
        <div style="margin-top: 20px;">
            <div class="section">
                <div class="section-header">í˜„ì¬ ì„¤ì •</div>
                <div class="section-content">
                    <div class="settings-kv">
                        <span>ë¸Œëœë“œ ê¸°ë³¸</span>
                        <span>${s.defaults.brand}</span>
                    </div>
                    <div class="settings-kv">
                        <span>í˜•íƒœ ê¸°ë³¸</span>
                        <span>${s.defaults.form}</span>
                    </div>
                    <div class="settings-kv">
                        <span>ì„¤ì¹˜</span>
                        <span>${s.defaults.location} / ${s.defaults.mount}</span>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <div class="section-header">ìµœê·¼ ë³€ê²½</div>
                <div class="section-content">
                    ${(s.history || []).slice(-5).reverse().map(h => `
                        <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            ${new Date(h.ts).toLocaleString()} - ${h.field || h.action}
                        </div>
                    `).join('') || '<div style="color: #999;">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                </div>
            </div>
        </div>
    `;
}

function updateSetting(field, value) {
    state.settings.defaults[field] = value;
    state.settings.history.push({
        ts: new Date().toISOString(),
        action: 'CHANGE',
        field: `defaults.${field}`,
        value
    });
    saveState();
    renderSettingsRight();
    showBanner('success', 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updateRule(rule, value) {
    state.settings.rules[rule] = value;
    state.settings.history.push({
        ts: new Date().toISOString(),
        action: 'CHANGE',
        field: `rules.${rule}`,
        value
    });
    saveState();
    renderSettingsRight();
}

function exportSettings() {
    const json = JSON.stringify(state.settings, null, 2);
    document.getElementById('settingsJson').value = json;
    navigator.clipboard.writeText(json);
    showBanner('success', 'ì„¤ì •ì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤');
}

function importSettings() {
    try {
        const json = document.getElementById('settingsJson').value;
        if (!json) {
            showBanner('error', 'JSONì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }
        state.settings = JSON.parse(json);
        saveState();
        renderSettingsTab();
        showBanner('success', 'ì„¤ì •ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
    } catch (e) {
        showBanner('error', 'JSON íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
    }
}

// ì—°ë™ í•¨ìˆ˜ë“¤
function sendEstimateEmail() {
    const quoteTab = state.tabs.find(t => t.id === state.activeTabId);
    if (!quoteTab || quoteTab.type !== 'quote') return;

    // ì´ë©”ì¼ íƒ­ ì°¾ê¸° ë˜ëŠ” ìƒì„±
    let emailTab = state.tabs.find(t => t.type === 'email');
    if (!emailTab) {
        addEmailTab();
        emailTab = state.tabs[state.tabs.length - 1];
    }

    // ì´ë©”ì¼ ì‘ì„± ìë™ ì±„ìš°ê¸°
    emailTab.data.compose = {
        to: quoteTab.data.customerInfo.email,
        cc: '',
        subject: `[ê²¬ì ì„œ] ${quoteTab.data.customerInfo.company} - ${new Date().toLocaleDateString()}`,
        body: `ì•ˆë…•í•˜ì„¸ìš”, ${quoteTab.data.customerInfo.company}ë‹˜

ìš”ì²­í•˜ì‹  ê²¬ì ì„œë¥¼ ì†¡ë¶€ë“œë¦½ë‹ˆë‹¤.
ê²€í†  í›„ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`,
        attachQuote: true
    };

    switchTab(emailTab.id);
    showBanner('success', 'ì´ë©”ì¼ ì‘ì„± í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤');
}

function addEstimateToCalendar() {
    const quoteTab = state.tabs.find(t => t.id === state.activeTabId);
    if (!quoteTab || quoteTab.type !== 'quote') return;

    // ìº˜ë¦°ë” íƒ­ ì°¾ê¸° ë˜ëŠ” ìƒì„±
    let calendarTab = state.tabs.find(t => t.type === 'calendar');
    if (!calendarTab) {
        addCalendarTab();
        calendarTab = state.tabs[state.tabs.length - 1];
    }

    // ë‚©ê¸°ì¼ ì¼ì • ì¶”ê°€
    const deliveryDate = new Date(Date.now() + 7*24*60*60*1000); // 7ì¼ í›„
    const event = {
        id: `cal_${Date.now()}`,
        type: 'estimate',
        title: `${quoteTab.data.customerInfo.company} ë‚©ê¸°`,
        start: deliveryDate.toISOString(),
        end: deliveryDate.toISOString(),
        location: quoteTab.data.customerInfo.address,
        memo: 'ê²¬ì ì„œ ê¸°ì¤€ ë‚©ê¸°ì¼',
        owner: 'ì˜ì—…íŒ€'
    };

    calendarTab.data.events.push(event);
    saveState();
    switchTab(calendarTab.id);
    showBanner('success', 'ìº˜ë¦°ë”ì— ë‚©ê¸° ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ìœ í‹¸ë¦¬í‹°
function showBanner(type, message) {
    const banner = document.createElement('div');
    banner.className = `banner ${type}`;
    banner.textContent = message;

    const rightPanel = document.getElementById('rightPanel');
    rightPanel.insertBefore(banner, rightPanel.firstChild);

    setTimeout(() => banner.remove(), 3000);
}

// ì•± ì‹œì‘
window.addEventListener('DOMContentLoaded', init);

// ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
window.addEventListener('click', (e) => {
    if (!e.target.closest('.new-tab-dropdown')) {
        document.getElementById('newTabMenu')?.classList.remove('show');
    }
});
</script>
</body>
</html>